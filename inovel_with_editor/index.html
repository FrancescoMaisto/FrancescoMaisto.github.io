<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Interactive Story Editor</title><style>:root{--color-ui-interaction:#007bff;--color-ui-green:#00a149;--color-ui-green-hover:#007233;--color-ui-red:#f54355;--color-ui-red-hover:#bd2130;--color-line-story:#797979;--color-line-chapter:#797979;--color-line-paragraph:#797979;--color-line-choice:#797979;--color-block-bg-top-story:#97e494;--color-block-bg-top-chapter:#f0e9c0;--color-block-bg-top-interactive:#afd2ff;--color-block-bg-top-passthru:#e0c5ff;--color-block-bg-top-infobox:#f5f396;--color-block-bg-top-choice:#fac0eb;--color-block-bg-bottom:#ffffff;--color-block-outline:#474747}body{font-family:'Roboto Condensed',sans-serif;margin:0;padding:0}h1{text-align:center;margin-top:10px}.navbar{position:sticky;z-index:9999;top:0;overflow:hidden;padding:10px 10px;background-color:#222;text-shadow:1px 1px 3px rgba(0,0,0,.9);box-shadow:3px 3px 6px rgba(0,0,0,.2)}.navbar .button{font-family:Inter,sans-serif;font-size:14px;padding:4px 10px;margin:0 4px;background-color:#444;color:#fff;border:1px solid #555;border-radius:6px;cursor:pointer;transition:background-color .2s ease}.navbar .button:hover{border:1px solid #888;background-color:#777}#playStory{background-color:var(--color-ui-red)}#playStory:hover{background-color:var(--color-ui-red-hover);border:1px solid var(--color-ui-red)}.navbarText{font-family:'Roboto Condensed',sans-serif;color:#fff;font-size:1em;padding:0 0 0 30px;display:inline-block;vertical-align:middle}.logo{font-family:'Roboto Condensed',sans-serif;color:#a0a0a0;font-weight:lighter;font-size:1em;padding:3px 13px 3px 13px;display:inline-block;vertical-align:middle;border:1px dashed #757575;background-color:#141414;box-shadow:0 0 6px rgb(134,134,134,.5)}.editor{position:relative;width:100%;height:160vh;background-color:#f4f4f4;border:1px solid #ccc;background-image:url(../images/bg.png);background-repeat:repeat;overflow:hidden;z-index:0}.block{position:absolute;width:130px;min-height:78px;border:2px solid var(--color-block-outline);border-radius:7px;cursor:move;text-align:left;user-select:none;padding-left:4px;padding-right:4px;box-sizing:border-box;box-shadow:3px 3px 6px rgba(0,0,0,.2);z-index:2}@keyframes flash-border{0%,100%{border-color:var(--color-block-outline)}50%{border-color:#ffbd5a}}.flash-animation{animation:flash-border .2s ease-in-out 4}.block.story{background:linear-gradient(to bottom,var(--color-block-bg-top-story) 23px,var(--color-block-bg-bottom) 20%)}.block.chapter{background:linear-gradient(to bottom,var(--color-block-bg-top-chapter) 23px,var(--color-block-bg-bottom) 20%)}.block.interactive{background:linear-gradient(to bottom,var(--color-block-bg-top-interactive) 23px,var(--color-block-bg-bottom) 20%)}.block.passthru{background:linear-gradient(to bottom,var(--color-block-bg-top-passthru) 23px,var(--color-block-bg-bottom) 20%)}.block.infobox{background:linear-gradient(to bottom,var(--color-block-bg-top-infobox) 23px,var(--color-block-bg-bottom) 20%)}.block.choice{background:linear-gradient(to bottom,var(--color-block-bg-top-choice) 23px,var(--color-block-bg-bottom) 20%)}.connector-story-chapter{stroke:var(--color-line-story);stroke-width:2}.connector-chapter-paragraph{stroke:var(--color-line-chapter);stroke-width:2}.connector-paragraph-choice{stroke:var(--color-line-paragraph);stroke-width:2}.connector-choice-all{stroke:var(--color-line-choice);stroke-width:2}.marker-story-chapter{fill:var(--color-line-story)}.marker-chapter-paragraph{fill:var(--color-line-chapter)}.marker-paragraph-choice{fill:var(--color-line-paragraph)}.marker-choice-all{fill:var(--color-line-choice)}#bg-header{font-size:1.8em;font-weight:700;user-select:none;display:inline-block;vertical-align:middle;margin-top:0;margin-bottom:20px;padding:13px 10px 10px 10px;width:100%;box-shadow:-1px 0 3px rgba(0,0,0,.4)}.bg-story{background-color:var(--color-block-bg-top-story)}.bg-chapter{background-color:var(--color-block-bg-top-chapter)}.bg-interactive{background-color:var(--color-block-bg-top-interactive)}.bg-passthru{background-color:var(--color-block-bg-top-passthru)}.bg-infobox{background-color:var(--color-block-bg-top-infobox)}.bg-choice{background-color:var(--color-block-bg-top-choice)}.keyword-label{color:#000;font-size:.9em;margin-top:6px}.id-label{color:#252525;font-size:.9em;margin-top:6px}.destination-label{color:#252525;font-size:.8em;border-top:1px solid #cacaca;margin-top:3px;padding-top:6px}.textbody-label{color:#575757;font-size:.8em;border-top:1px solid #cacaca;margin-top:3px;padding-top:6px;padding-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}.svg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}#svgCanvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}.properties-panel{position:fixed;top:40px;right:0;width:300px;height:100%;background-color:rgba(240,240,240,.8);border-left:1px solid #797979;padding:0 0;box-shadow:-2px 0 5px rgba(0,0,0,.2);overflow-y:auto;display:none;z-index:1000;box-sizing:border-box}.close-button{position:absolute;top:22px;right:10px;width:24px;height:24px;background-color:var(--color-ui-red);color:#fff;border:3px solid #fff;border-radius:6px;cursor:pointer;font-size:14px;font-weight:700;line-height:20px;text-align:center;padding:0;z-index:1001;vertical-align:middle}.close-button:hover{background-color:var(--color-ui-red-hover)}.edit-save-button{width:18px;height:18px;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:0;font-size:12px;position:absolute;right:5px;top:4px}.edit-save-button:hover{background-color:var(--color-ui-interaction)}.image-preview-icon{width:18px;height:18px;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:0;font-size:14px;position:absolute;right:30px;top:3px}.image-preview-icon:hover{background-color:var(--color-ui-green)}.property-input{font-family:'Roboto Condensed',sans-serif;font-size:16px;padding:4px;margin:2px 0;border:2px solid #007bff;border-radius:3px}.property-textarea{width:100%;font-family:'Roboto Condensed',sans-serif;font-size:16px;padding:4px;margin:2px 0;border:2px solid #007bff;border-radius:3px;resize:vertical;min-height:60px}.properties-panel p{margin:0 12px 5px 13px}.property{font-size:16px;color:#000;padding:10px 25px 10px 10px;background-color:#eee;border:1px solid #ccc;position:relative;border-radius:6px}.editable-property{background-color:#fdfdfd}.editable{display:inline}.editable[data-property=image]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;max-width:240px}.selection-box{position:absolute;border:2px dotted #007bff;background-color:rgba(0,123,255,.1);pointer-events:none;z-index:3;display:none}.block.selected{border:3px solid var(--color-ui-interaction);box-shadow:3px 3px #007bff,6px 6px 5px rgba(0,0,0,.8)}.block.multi-selected{border:3px solid var(--color-ui-interaction);box-shadow:3px 3px #007bff,6px 6px 5px rgba(0,0,0,.8)}.panel-buttons-container{position:absolute;bottom:25px;left:0;right:0;padding:15px;display:flex;flex-direction:column;gap:5px}.delete-button,.new-choice-button{font-family:Inter,sans-serif;font-size:14px;padding:12px 16px;width:100%;color:#fff;border:none;border-radius:6px;cursor:pointer;transition:background-color .2s ease}.new-choice-button{background-color:var(--color-ui-green)}.new-choice-button:hover{background-color:var(--color-ui-green-hover)}.delete-button{background-color:var(--color-ui-red)}.delete-button:hover{background-color:var(--color-ui-red-hover)}.button-container,.new-choice-container{border:none;display:none}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.4);z-index:10000;display:none}.confirmation-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.35);z-index:10001;min-width:300px;display:none}.dialog-header{font-size:1.2em;font-weight:700;margin-bottom:15px;color:#333}.dialog-message{margin-bottom:20px;color:#666}.dialog-buttons{display:flex;justify-content:flex-end;gap:10px}.dialog-button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;color:#fff;transition:background-color .2s ease}.dialog-button-cancel{background-color:#6c757d}.dialog-button-cancel:hover{background-color:#5a6268}.dialog-button-ok{background-color:var(--color-ui-red)}.dialog-button-ok:hover{background-color:var(--color-ui-red-hover)}#appContainer{position:fixed;top:40px;right:0;width:400px;height:calc(100vh - 40px);background-color:#fff;border-left:1px solid #797979;box-shadow:-2px 0 5px rgba(0,0,0,.2);z-index:9998;display:none;overflow-y:auto;padding:0;box-sizing:border-box}.image-preview-tooltip{position:fixed;font-size:.8em;color:#fff;text-shadow:-2px -2px 0 #000,2px -2px 0 #000,-2px 2px 0 #000,2px 2px 0 #000;text-align:center;max-width:200px;background-color:#fff;border:2px solid #dbdbdb;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;display:none;z-index:10000;background-size:contain;background-repeat:no-repeat;background-position:center}.image-preview-tooltip.error{font-size:14px;text-shadow:none;display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;color:red}</style><style>:root{--color-ui-interaction:#007bff;--color-ui-green:#00a149;--color-ui-green-hover:#007233;--color-ui-red:#f54355;--color-ui-red-hover:#bd2130;--color-line-story:#797979;--color-line-chapter:#797979;--color-line-paragraph:#797979;--color-line-choice:#797979;--color-block-bg-top-story:#97e494;--color-block-bg-top-chapter:#f0e9c0;--color-block-bg-top-interactive:#afd2ff;--color-block-bg-top-passthru:#e0c5ff;--color-block-bg-top-infobox:#f5f396;--color-block-bg-top-choice:#fac0eb;--color-block-bg-bottom:#ffffff;--color-block-outline:#474747}body{font-family:'Roboto Condensed',sans-serif;margin:0;padding:0}h1{text-align:center;margin-top:10px}.navbar{position:sticky;z-index:9999;top:0;overflow:hidden;padding:10px 10px;background-color:#222;text-shadow:1px 1px 3px rgba(0,0,0,.9);box-shadow:3px 3px 6px rgba(0,0,0,.2)}.navbar .button{font-family:Inter,sans-serif;font-size:14px;padding:4px 10px;margin:0 4px;background-color:#444;color:#fff;border:1px solid #555;border-radius:6px;cursor:pointer;transition:background-color .2s ease}.navbar .button:hover{border:1px solid #888;background-color:#777}#playStory{background-color:var(--color-ui-red)}#playStory:hover{background-color:var(--color-ui-red-hover);border:1px solid var(--color-ui-red)}.navbarText{font-family:'Roboto Condensed',sans-serif;color:#fff;font-size:1em;padding:0 0 0 30px;display:inline-block;vertical-align:middle}.logo{font-family:'Roboto Condensed',sans-serif;color:#a0a0a0;font-weight:lighter;font-size:1em;padding:3px 13px 3px 13px;display:inline-block;vertical-align:middle;border:1px dashed #757575;background-color:#141414;box-shadow:0 0 6px rgb(134,134,134,.5)}.editor{position:relative;width:100%;height:160vh;background-color:#f4f4f4;border:1px solid #ccc;background-image:url(../images/bg.png);background-repeat:repeat;overflow:hidden;z-index:0}.block{position:absolute;width:130px;min-height:78px;border:2px solid var(--color-block-outline);border-radius:7px;cursor:move;text-align:left;user-select:none;padding-left:4px;padding-right:4px;box-sizing:border-box;box-shadow:3px 3px 6px rgba(0,0,0,.2);z-index:2}@keyframes flash-border{0%,100%{border-color:var(--color-block-outline)}50%{border-color:#ffbd5a}}.flash-animation{animation:flash-border .2s ease-in-out 4}.block.story{background:linear-gradient(to bottom,var(--color-block-bg-top-story) 23px,var(--color-block-bg-bottom) 20%)}.block.chapter{background:linear-gradient(to bottom,var(--color-block-bg-top-chapter) 23px,var(--color-block-bg-bottom) 20%)}.block.interactive{background:linear-gradient(to bottom,var(--color-block-bg-top-interactive) 23px,var(--color-block-bg-bottom) 20%)}.block.passthru{background:linear-gradient(to bottom,var(--color-block-bg-top-passthru) 23px,var(--color-block-bg-bottom) 20%)}.block.infobox{background:linear-gradient(to bottom,var(--color-block-bg-top-infobox) 23px,var(--color-block-bg-bottom) 20%)}.block.choice{background:linear-gradient(to bottom,var(--color-block-bg-top-choice) 23px,var(--color-block-bg-bottom) 20%)}.connector-story-chapter{stroke:var(--color-line-story);stroke-width:2}.connector-chapter-paragraph{stroke:var(--color-line-chapter);stroke-width:2}.connector-paragraph-choice{stroke:var(--color-line-paragraph);stroke-width:2}.connector-choice-all{stroke:var(--color-line-choice);stroke-width:2}.marker-story-chapter{fill:var(--color-line-story)}.marker-chapter-paragraph{fill:var(--color-line-chapter)}.marker-paragraph-choice{fill:var(--color-line-paragraph)}.marker-choice-all{fill:var(--color-line-choice)}#bg-header{font-size:1.8em;font-weight:700;user-select:none;display:inline-block;vertical-align:middle;margin-top:0;margin-bottom:20px;padding:13px 10px 10px 10px;width:100%;box-shadow:-1px 0 3px rgba(0,0,0,.4)}.bg-story{background-color:var(--color-block-bg-top-story)}.bg-chapter{background-color:var(--color-block-bg-top-chapter)}.bg-interactive{background-color:var(--color-block-bg-top-interactive)}.bg-passthru{background-color:var(--color-block-bg-top-passthru)}.bg-infobox{background-color:var(--color-block-bg-top-infobox)}.bg-choice{background-color:var(--color-block-bg-top-choice)}.keyword-label{color:#000;font-size:.9em;margin-top:6px}.id-label{color:#252525;font-size:.9em;margin-top:6px}.destination-label{color:#252525;font-size:.8em;border-top:1px solid #cacaca;margin-top:3px;padding-top:6px}.textbody-label{color:#575757;font-size:.8em;border-top:1px solid #cacaca;margin-top:3px;padding-top:6px;padding-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}.svg-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}#svgCanvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}.properties-panel{position:fixed;top:40px;right:0;width:300px;height:100%;background-color:rgba(240,240,240,.8);border-left:1px solid #797979;padding:0 0;box-shadow:-2px 0 5px rgba(0,0,0,.2);overflow-y:auto;display:none;z-index:1000;box-sizing:border-box}.close-button{position:absolute;top:22px;right:10px;width:24px;height:24px;background-color:var(--color-ui-red);color:#fff;border:3px solid #fff;border-radius:6px;cursor:pointer;font-size:14px;font-weight:700;line-height:20px;text-align:center;padding:0;z-index:1001;vertical-align:middle}.close-button:hover{background-color:var(--color-ui-red-hover)}.edit-save-button{width:18px;height:18px;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:0;font-size:12px;position:absolute;right:5px;top:4px}.edit-save-button:hover{background-color:var(--color-ui-interaction)}.image-preview-icon{width:18px;height:18px;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:0;font-size:14px;position:absolute;right:30px;top:3px}.image-preview-icon:hover{background-color:var(--color-ui-green)}.property-input{font-family:'Roboto Condensed',sans-serif;font-size:16px;padding:4px;margin:2px 0;border:2px solid #007bff;border-radius:3px}.property-textarea{width:100%;font-family:'Roboto Condensed',sans-serif;font-size:16px;padding:4px;margin:2px 0;border:2px solid #007bff;border-radius:3px;resize:vertical;min-height:60px}.properties-panel p{margin:0 12px 5px 13px}.property{font-size:16px;color:#000;padding:10px 25px 10px 10px;background-color:#eee;border:1px solid #ccc;position:relative;border-radius:6px}.editable-property{background-color:#fdfdfd}.editable{display:inline}.editable[data-property=image]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;max-width:240px}.selection-box{position:absolute;border:2px dotted #007bff;background-color:rgba(0,123,255,.1);pointer-events:none;z-index:3;display:none}.block.selected{border:3px solid var(--color-ui-interaction);box-shadow:3px 3px #007bff,6px 6px 5px rgba(0,0,0,.8)}.block.multi-selected{border:3px solid var(--color-ui-interaction);box-shadow:3px 3px #007bff,6px 6px 5px rgba(0,0,0,.8)}.panel-buttons-container{position:absolute;bottom:25px;left:0;right:0;padding:15px;display:flex;flex-direction:column;gap:5px}.delete-button,.new-choice-button{font-family:Inter,sans-serif;font-size:14px;padding:12px 16px;width:100%;color:#fff;border:none;border-radius:6px;cursor:pointer;transition:background-color .2s ease}.new-choice-button{background-color:var(--color-ui-green)}.new-choice-button:hover{background-color:var(--color-ui-green-hover)}.delete-button{background-color:var(--color-ui-red)}.delete-button:hover{background-color:var(--color-ui-red-hover)}.button-container,.new-choice-container{border:none;display:none}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.4);z-index:10000;display:none}.confirmation-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.35);z-index:10001;min-width:300px;display:none}.dialog-header{font-size:1.2em;font-weight:700;margin-bottom:15px;color:#333}.dialog-message{margin-bottom:20px;color:#666}.dialog-buttons{display:flex;justify-content:flex-end;gap:10px}.dialog-button{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;color:#fff;transition:background-color .2s ease}.dialog-button-cancel{background-color:#6c757d}.dialog-button-cancel:hover{background-color:#5a6268}.dialog-button-ok{background-color:var(--color-ui-red)}.dialog-button-ok:hover{background-color:var(--color-ui-red-hover)}#appContainer{position:fixed;top:40px;right:0;width:400px;height:calc(100vh - 40px);background-color:#fff;border-left:1px solid #797979;box-shadow:-2px 0 5px rgba(0,0,0,.2);z-index:9998;display:none;overflow-y:auto;padding:0;box-sizing:border-box}.image-preview-tooltip{position:fixed;font-size:.8em;color:#fff;text-shadow:-2px -2px 0 #000,2px -2px 0 #000,-2px 2px 0 #000,2px 2px 0 #000;text-align:center;max-width:200px;background-color:#fff;border:2px solid #dbdbdb;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;display:none;z-index:10000;background-size:contain;background-repeat:no-repeat;background-position:center}.image-preview-tooltip.error{font-size:14px;text-shadow:none;display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;color:red}</style><link rel="stylesheet" href="editor/css/style.css"><link rel="icon" type="image/png" href="editor/images/favicon/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="editor/images/favicon/favicon.svg"><link rel="shortcut icon" href="editor/images/favicon/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="editor/images/favicon/apple-touch-icon.png"><link rel="manifest" href="editor/images/favicon/site.webmanifest"><meta property="og:site_name" content="Interactive Novel"><meta property="og:title" content="The Old Well"><meta property="og:type" content="website"><meta property="og:url" content="https://francescomaisto.github.io/inovel_with_editor/"><meta property="og:description" content="Interactive Novel - Shape your own story while you read it"><meta property="og:image" content="https://francescomaisto.github.io/inovel/images/favicon/web-app-manifest-512x512.png"></head><body><div class="navbar"><span class="logo">INTERACTIVE STORY EDITOR</span> <span class="navbarText">STORY</span> <button id="newStory" class="button">📗 New</button> <button id="loadStory" class="button">🔼 Load...</button> <button id="saveStory" class="button">💾 Save...</button> <button id="playStory" class="button">▶ Play</button> <span class="navbarText">BLOCKS</span> <button id="newBlock_Interactive" class="button">👉 Interactive</button> <button id="newBlock_PassThru" class="button">🚪 Pass-through</button> <button id="newBlock_InfoBox" class="button">💡 Info Box</button></div><input type="file" id="fileInput" accept=".json" style="display:none"><div id="editor" class="editor"><svg id="svgCanvas" class="svg-overlay"><defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#000"/></marker></defs></svg></div><div id="dialogOverlay" class="dialog-overlay"></div><div id="confirmationDialog" class="confirmation-dialog"><div class="dialog-header">Delete Block</div><div class="dialog-message">Are you sure you want to delete this block?</div><div class="dialog-buttons"><button id="dialogOK" class="dialog-button dialog-button-ok">OK</button> <button id="dialogCancel" class="dialog-button dialog-button-cancel">Cancel</button></div></div><div id="propertiesPanel" class="properties-panel"><button id="closePropertiesPanel" class="close-button">X</button></div><div id="appContainer"></div><script>let jsonFileNames={default:"editor/stories/il_vecchio_pozzo_TEST.json",new:"editor/stories/the_hobbit.json"},currentData=null,blocks={},connections=[],choiceConnections=[],editor,svgCanvas,propertiesPanel,closePropertiesPanel,paragraphBlocksByJsonId={},selectionBox=null,selectionStart=null,selectedBlocks=new Set,isMultiDragging=!1,multiDragOffset=null,headerLabel={emoji:{story:"📗",chapter:"📚",interactive:"👉",passThru:"⏬",infoBox:"💡",choice:"🎯"},text:{story:"Story",chapter:"Chapter",interactive:"Interactive",passThru:"Pass-through",infoBox:"Info Box",choice:"Choice"}};function init(){editor=document.getElementById("editor"),svgCanvas=document.getElementById("svgCanvas"),(closePropertiesPanel=document.getElementById("closePropertiesPanel")).addEventListener("click",()=>{togglePropertiesPanelVisibility(!1),removeHighlightFromBlocks()}),fetchJSON(jsonFileNames.default),setupSelectionBox()}function fetchJSON(e){fetch(e).then(e=>e.json()).then(e=>{createFlowchart(currentData=e)}).catch(e=>console.error("Error loading JSON:",e))}function createFlowchart(e){let t=0;e.story.chapters.forEach(e=>{(e=150*e.paragraphs.length-30)>t&&(t=e)});var a=e.story.position?e.story.position[0]:100+(t-120)/2,r=e.story.position?e.story.position[1]:20,a=createBlock("story",headerLabel.text.story,a,r);blocks.story=a,(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.story.title,a.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText=e.story.author,a.appendChild(r);let c=null;e.story.chapters.forEach((e,s)=>{let l="chapter-"+s;e.paragraphs.forEach((e,o)=>{let n=`paragraph-${s}-`+o,i=100+150*o,t=e.position?e.position[0]:i,a=e.position?e.position[1]:300,r;"interactive"===e.type?r=headerLabel.text.interactive:"passThru"===e.type?r=headerLabel.text.passThru:"infoBox"===e.type&&(r=headerLabel.text.infoBox),t=createBlock(n,r,t,a),blocks[n]=t,connections.push({from:l,to:n}),(paragraphBlocksByJsonId[e.id]=t).dataset.jsonId=e.id,t.dataset.type=e.type,e.destination_id&&""!==e.destination_id.trim&&(t.dataset.destId=e.destination_id),0===e.id&&(c=n),createIdLabel(e.id,t),"passThru"!==e.type&&"infoBox"!==e.type||createDestIdLabel(e.destination_id,t),createTextBodyLabel(e.text_body,t),e.choices&&e.choices.forEach((e,t)=>{var a=`choice-${s}-${o}-`+t,t=i+150*t,t=e.position?e.position[0]:t,r=e.position?e.position[1]:450;(t=createBlock(a,headerLabel.text.choice,t,r)).dataset.destId=e.destination_id,blocks[a]=t,connections.push({from:n,to:a}),(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.text_body,t.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText="Destination ID: "+e.destination_id,t.appendChild(r),(t=paragraphBlocksByJsonId[e.destination_id])&&choiceConnections.push({from:a,to:getBlockId(t)})})})}),c&&connections.push({from:"story",to:c}),updateConnections(),editor.addEventListener("mousedown",e=>{let t=e.target;for(;t&&!t.classList.contains("block");)t=t.parentElement;t&&t.classList.contains("block")?(e=t.getAttribute("data-id"),0===selectedBlocks.size&&(highlightBlock(t),displayProperties(e))):(removeHighlightFromBlocks(),selectedBlocks.clear(),togglePropertiesPanelVisibility(!1))})}function getBlockId(e){return e.getAttribute("data-id")}function flashNewBlock(e){e.classList.add("flash-animation"),setTimeout(()=>{e.classList.remove("flash-animation")},1200)}function createBlock(e,t,a,r,o=!1){var n=document.createElement("div");n.classList.add("block");let i="";return t===headerLabel.text.story?(n.classList.add("story"),i=headerLabel.emoji.story):t===headerLabel.text.chapter?(n.classList.add("chapter"),i=headerLabel.emoji.chapter):t===headerLabel.text.interactive?(n.classList.add("interactive"),i=headerLabel.emoji.interactive):t===headerLabel.text.passThru?(n.classList.add("passthru"),i=headerLabel.emoji.passThru):t===headerLabel.text.infoBox?(n.classList.add("infobox"),i=headerLabel.emoji.infoBox):t===headerLabel.text.choice&&(n.classList.add("choice"),i=headerLabel.emoji.choice),t=i+" "+t,n.innerHTML=`<strong>${t}</strong>`,n.style.left=a+"px",n.style.top=r+"px",n.setAttribute("data-id",e),editor.appendChild(n),makeDraggable(n),o&&flashNewBlock(n),n}function setupMarkers(e){let r=document.createElementNS("http://www.w3.org/2000/svg","defs");function t(e,t){var a=document.createElementNS("http://www.w3.org/2000/svg","marker");a.setAttribute("id",e),a.setAttribute("markerWidth","10"),a.setAttribute("markerHeight","10"),a.setAttribute("refX","6"),a.setAttribute("refY","3"),a.setAttribute("orient","auto"),(e=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d","M0,0 L0,6 L6,3 z"),e.classList.add(t),a.appendChild(e),r.appendChild(a)}t("arrowStoryChapter","marker-story-chapter"),t("arrowChapterParagraph","marker-chapter-paragraph"),t("arrowParagraphChoice","marker-paragraph-choice"),t("arrowChoiceAll","marker-choice-all"),e.appendChild(r)}function drawConnectorChoiceToParagraph(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-choice-all"),n.setAttribute("marker-end","url(#arrowChoiceAll)"),a.appendChild(n)}function drawDestinationConnector(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-chapter-paragraph"),n.setAttribute("marker-end","url(#arrowChapterParagraph)"),a.appendChild(n)}function getMarkerUrl(e){return"story-chapter"===e?"url(#arrowStoryChapter)":"chapter-paragraph"===e?"url(#arrowChapterParagraph)":"paragraph-choice"===e?"url(#arrowParagraphChoice)":"url(#arrow)"}function drawConnection(e,t,a,r){var{x:e,y:o}=getBlockCenter(e),{x:t,y:n}=getEdgePoint(t,e,o);(e=createLine(e,o,t,n,a)).setAttribute("marker-end",getMarkerUrl(a)),r.appendChild(e)}function updateConnections(){for(;svgCanvas.firstChild;)svgCanvas.removeChild(svgCanvas.firstChild);setupMarkers(svgCanvas),connections.forEach(e=>{var t,a=blocks[e.from],e=blocks[e.to];a&&e&&(t=a.classList.contains("story")?"story-chapter":a.classList.contains("chapter")&&e.classList.contains("paragraph")?"chapter-paragraph":"paragraph-choice",drawConnection(a,e,t,svgCanvas))}),choiceConnections.forEach(e=>{var t=blocks[e.from],e=blocks[e.to];t&&e&&drawConnection(t,e,"paragraph-choice",svgCanvas)});let e=document.querySelectorAll(".block"),t=Array.from(e).filter(e=>e.classList.contains("choice")),a=Array.from(e).filter(e=>e.classList.contains("interactive")||e.classList.contains("passthru")||e.classList.contains("infobox"));t.forEach(t=>{a.forEach(e=>{t.dataset.destId===e.dataset.jsonId&&drawConnectorChoiceToParagraph(t,e,svgCanvas)})}),document.querySelectorAll(".block.passthru, .block.infobox").forEach(e=>{var t;e.dataset.destId&&(t=paragraphBlocksByJsonId[e.dataset.destId])&&drawDestinationConnector(e,t,svgCanvas)})}function createLine(e,t,a,r,o){var n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",e),n.setAttribute("x2",a),n.setAttribute("y1",t),n.setAttribute("y2",r),n.classList.add("connector-"+o),n}function getBlockCenter(e){var e=e.getBoundingClientRect(),t=editor.getBoundingClientRect();return{x:e.left-t.left+e.width/2,y:e.top-t.top+e.height/2}}function getEdgePoint(e,t,a){var e=e.getBoundingClientRect(),r=editor.getBoundingClientRect(),o=e.left-r.left+e.width/2,n=e.top-r.top+e.height/2,r=o-t;return t=n-a,a=Math.atan2(t,r),t=e.width/2,r=e.height/2,e=t/Math.abs(Math.cos(a)),t=r/Math.abs(Math.sin(a)),r=Math.min(e,t),{x:o-Math.cos(a)*r,y:n-Math.sin(a)*r}}function makeDraggable(t){let a=0,r=0,o=!1;t.addEventListener("mousedown",e=>{0<selectedBlocks.size&&(selectedBlocks.has(t)?(isMultiDragging=!0,multiDragOffset={x:e.clientX,y:e.clientY}):(selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}))),o=!0,a=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop,t.style.zIndex=1e3}),document.addEventListener("mousemove",e=>{if(o){if(isMultiDragging){let t=e.clientX-multiDragOffset.x,a=e.clientY-multiDragOffset.y;selectedBlocks.forEach(e=>{e.style.left=e.offsetLeft+t+"px",e.style.top=e.offsetTop+a+"px"}),multiDragOffset.x=e.clientX,multiDragOffset.y=e.clientY}else t.style.left=e.clientX-a+"px",t.style.top=e.clientY-r+"px";updateConnections()}}),document.addEventListener("mouseup",()=>{o&&(o=!1,isMultiDragging=!1,t.style.zIndex="")})}function highlightBlock(e){removeHighlightFromBlocks(),e.classList.add("selected")}function setupSelectionBox(){let a=!1,n=null;(n=document.createElement("div")).className="selection-box",editor.appendChild(n),editor.addEventListener("mousedown",e=>{var t;e.target!==editor&&e.target!==svgCanvas||(a=!0,t=editor.getBoundingClientRect(),selectionStart={x:e.clientX-t.left+editor.scrollLeft,y:e.clientY-t.top+editor.scrollTop},n.style.display="block",n.style.left=selectionStart.x+"px",n.style.top=selectionStart.y+"px",n.style.width="0",n.style.height="0",selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}),e.preventDefault())}),document.addEventListener("mousemove",e=>{if(a){var t=editor.getBoundingClientRect(),r=e.clientX-t.left+editor.scrollLeft,e=e.clientY-t.top+editor.scrollTop,t=Math.min(r,selectionStart.x),o=Math.min(e,selectionStart.y),r=Math.abs(r-selectionStart.x),e=Math.abs(e-selectionStart.y);n.style.left=t+"px",n.style.top=o+"px",n.style.width=r+"px",n.style.height=e+"px";let a=n.getBoundingClientRect();document.querySelectorAll(".block").forEach(e=>{var t=e.getBoundingClientRect();rectsOverlap(a,t)?(selectedBlocks.add(e),e.classList.add("multi-selected")):(selectedBlocks.delete(e),e.classList.remove("multi-selected"))})}}),document.addEventListener("mouseup",()=>{var e;a&&(a=!1,n.style.display="none",1===selectedBlocks.size)&&(displayProperties((e=selectedBlocks.values().next().value).getAttribute("data-id"),currentData),highlightBlock(e))})}function rectsOverlap(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}function findLowestAvailableId(){let t=new Set,e=(currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{t.add(e.id)})}),0);for(;t.has(e);)e++;return e}function createNewParagraph(e){var t,a,r,o,n;currentData&&currentData.story&&currentData.story.chapters&&0!==currentData.story.chapters.length?(a={id:t=findLowestAvailableId(),type:e,text_body:"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus lacinia odio vitae vestibulum vestibulum.",position:[100,100]},(r=currentData.story.chapters[0]).paragraphs.push(a),(o=createBlock(r="paragraph-0-"+(r.paragraphs.length-1),headerLabel.text[e],a.position[0],a.position[1],!0)).dataset.type=e,createIdLabel(o.dataset.jsonId=t,o),"interactive"===e?(n=a.text_body,a.text_body=n.slice(0,n.length-1)+" {keyword}"+n.slice(n.length-1)):"passThru"!==e&&"infoBox"!==e||createDestIdLabel("",o),createTextBodyLabel(a.text_body,o),blocks[r]=o,paragraphBlocksByJsonId[t]=o,updateConnections()):alert("Please load a story first!")}function createIdLabel(e,t){var a=document.createElement("div");a.classList.add("id-label"),a.innerHTML=`ID: <strong>${e}</strong>`,t.appendChild(a)}function createDestIdLabel(e,t){let a=void 0===e?"":e;(e=document.createElement("div")).classList.add("destination-label"),e.innerText="Destination ID: "+a,t.appendChild(e)}function createTextBodyLabel(e,t){var a=document.createElement("div");a.classList.add("textbody-label"),a.innerText=e,t.appendChild(a)}function cleanupOldFlowchart(e){for(var t=document.getElementById("editor").getElementsByClassName("block");t.length;)t[0].remove();var a=document.getElementById("svgCanvas");Array.from(a.childNodes).forEach(e=>{"defs"!==e.nodeName&&e.remove()}),currentData=e,paragraphBlocksByJsonId={},connections=[],choiceConnections=[]}document.addEventListener("DOMContentLoaded",()=>{init()}),window.removeHighlightFromBlocks=function(){document.querySelectorAll(".block").forEach(e=>{e.classList.remove("selected")})},document.getElementById("newBlock_Interactive").addEventListener("click",()=>createNewParagraph("interactive")),document.getElementById("newBlock_PassThru").addEventListener("click",()=>createNewParagraph("passThru")),document.getElementById("newBlock_InfoBox").addEventListener("click",()=>createNewParagraph("infoBox")),document.getElementById("playStory").addEventListener("click",function(){let t=window.open("./app/index.html","StoryPreview","width=500,height=900,resizable=yes,scrollbars=yes");t.addEventListener("load",function(){var e=JSON.stringify(currentData,null,2),e=(console.log("Sending story data to preview:",e),{storyData:e,isDebug:!1});t.postMessage(e,"*")})}),document.getElementById("saveStory").addEventListener("click",()=>{blocks.story&&(e=blocks.story,currentData.story.position=[parseInt(e.style.left,10),parseInt(e.style.top,10)]),currentData.story.chapters.forEach((e,r)=>{var t=blocks["chapter-"+r];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.paragraphs.forEach((e,a)=>{var t=blocks[`paragraph-${r}-`+a];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.choices&&e.choices.forEach((e,t)=>{(t=blocks[`choice-${r}-${a}-`+t])&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)])})})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{var t=paragraphBlocksByJsonId[e.id];(t=t&&t.querySelector('[data-property="text_body"]'))&&(e.text_body=t.innerText)})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{null!=e.destination_id&&""!==String(e.destination_id).trim()||(console.error("ATTENTION! There is an empty/null/undefined 'destination_id' in the data structure (currentData) that I had to remove. Make sure that empty/null/undefined 'destination_id's never get added to currentData in the first place!"),delete e.destination_id)})});var e=JSON.stringify(currentData,null,2),e=(console.log("Generated Story JSON:",e),new Blob([e],{type:"application/json"})),t=document.createElement("a"),a=currentData.story.title.toLowerCase().replace(/ /g,"_");t.download=a+".json",t.href=URL.createObjectURL(e),document.body.appendChild(t),t.click(),document.body.removeChild(t)}),document.getElementById("newStory").addEventListener("click",async()=>{try{var e=await fetch(jsonFileNames.new);if(!e.ok)throw new Error("Failed to load new JSON template");var t=await e.json();cleanupOldFlowchart(t),createFlowchart(t)}catch(e){console.error("Error creating new story:",e),alert("Error creating new story. Please check if the template file exists.")}}),document.getElementById("loadStory").addEventListener("click",()=>{document.getElementById("fileInput").click()}),document.getElementById("fileInput").addEventListener("change",a=>{var e,t=a.target.files[0];t&&((e=new FileReader).onload=function(e){try{var t=JSON.parse(e.target.result);cleanupOldFlowchart(t),createFlowchart(t),a.target.value=""}catch(e){console.error("Error loading story:",e),alert("Error loading story. Please select a valid JSON file.")}},e.readAsText(t))});let panelHeader="<div id='bg-header' ",panelInfo="<p class='panel-info'>",property="<p class='property'>",editableProperty="<p class='property editable-property'>",editableSpan=" <span class='editable' ",isEditingImage=!1;function calculateTextareaRows(e){return e=Math.ceil(e.length/30),Math.min(Math.max(e,3),30)}function createImagePreviewIcon(e,t,a){var r=document.createElement("span");return r.textContent="👁‍🗨",r.className="image-preview-icon",r}function createEditButton(t,a,r){let o=document.createElement("button");return o.textContent="📝",o.className="edit-save-button",o.onclick=e=>{e.stopPropagation(),startEditing(t,a,r,o)},o}function createSaveButton(t,a,r,o){let n=document.createElement("button");return n.textContent="💾",n.className="edit-save-button",n.onclick=e=>{e.stopPropagation(),commitChanges(t,a,r,o,n)},n}function startEditing(t,a,r,e){let o=a.startsWith("paragraph-")&&("text_body"===r||"image"===r);var n;"image"===r&&(isEditingImage=!0,n=document.querySelector(".image-preview-tooltip"))&&(n.style.display="none");let i,s=(o?(i=document.createElement("textarea")).className="property-textarea":((i=document.createElement("input")).className="property-input",n=document.getElementById("propertiesPanel").offsetWidth,i.style.width=n-65+"px"),i.value=t.innerText,t.style.display="none",t.parentNode.style.backgroundColor="#f5ffba",t.parentNode.insertBefore(i,t),createSaveButton(t,a,r,i));e.replaceWith(s),o?(n=calculateTextareaRows(t.innerText),i.rows=n):i.select(),i.focus(),i.addEventListener("keydown",function(e){("Enter"===e.key&&!o||"Enter"===e.key&&e.ctrlKey&&o)&&commitChanges(t,a,r,i,s)})}function commitChanges(e,t,a,r,o){e.innerText=r.value,updateDataFromPanel(t,a,r.value),e.parentNode.style.backgroundColor="#fdfdfd",r.remove(),r=createEditButton(e,t,a),o.replaceWith(r),"image"===a?(e.style.display="block",isEditingImage=!1):e.style.display="inline"}function addNewChoiceButton(e,t){var a,r;"interactive"===e.dataset.type&&((a=document.createElement("div")).classList.add("new-choice-container"),(r=document.createElement("button")).innerText="🎯 Add Choice",r.classList.add("new-choice-button"),r.addEventListener("click",()=>createNewChoice(e)),a.appendChild(r),propertiesPanel.appendChild(a))}function createNewChoice(e){let r=e.dataset.jsonId,o,n,i;var t,a,s,l;currentData.story.chapters.forEach((e,a)=>{e.paragraphs.forEach((e,t)=>{e.id.toString()===r&&(o=e,n=a,i=t)})}),o&&(o.choices||(o.choices=[]),t={text_body:"New Choice",destination_id:"",position:[parseInt(e.style.left)+150,parseInt(e.style.top)+150]},o.choices.push(t),(s=createBlock(a=`choice-${n}-${i}-`+(o.choices.length-1),"Choice",t.position[0],t.position[1],!0)).dataset.destId=t.destination_id,blocks[a]=s,(l=document.createElement("div")).classList.add("keyword-label"),l.innerText=t.text_body,s.appendChild(l),(l=document.createElement("div")).classList.add("destination-label"),l.innerText="Destination ID: "+t.destination_id,s.appendChild(l),connections.push({from:getBlockId(e),to:a}),updateConnections())}function displayProperties(o){var n=document.getElementById("propertiesPanel");if(n.innerHTML='<button id="closePropertiesPanel" class="close-button">X</button>',togglePropertiesPanelVisibility(!0),"story"===o){let e=`
      ${panelHeader}class="bg-story">${headerLabel.emoji.story} ${headerLabel.text.story}</div>
      ${editableProperty}<strong>Title:</strong>${editableSpan}data-property="title">${currentData.story.title}</span></p>
      ${editableProperty}<strong>Author:</strong>${editableSpan}data-property="author">${currentData.story.author}</span></p>
      ${editableProperty}<strong>Date:</strong>${editableSpan}data-property="date">${currentData.story.date}</span></p>
    `;currentData.story.stylesheet&&(e+=`${editableProperty}<strong>Style Sheet:</strong>${editableSpan}data-property="stylesheet">${currentData.story.stylesheet}</span></p>`),currentData.story.typingSpeed&&(e+=`${editableProperty}<strong>Typing Speed:</strong>${editableSpan}data-property="typingSpeed">${currentData.story.typingSpeed}</span></p>`),void 0!==currentData.story.hasInventory&&(e+=`${editableProperty}<strong>Has Inventory:</strong>${editableSpan}data-property="hasInventory">${currentData.story.hasInventory}</span></p>`),currentData.story.hasInventory&&(e=(e+=`${editableProperty}<strong>Inventory Name:</strong>${editableSpan}data-property="inventoryName">${currentData.story.inventoryName}</span></p>`)+`${editableProperty}<strong>Inventory Empty:</strong>${editableSpan}data-property="inventoryEmpty">${currentData.story.inventoryEmpty}</span></p>`),n.innerHTML+=e}else if(o.startsWith("chapter-")){var i=parseInt(o.split("-")[1]),i=(currentData.story.chapters[i],`
      ${panelHeader}class="bg-chapter">${headerLabel.emoji.chapter} ${headerLabel.text.chapter}</div>
    `);n.innerHTML+=i}else if(o.startsWith("paragraph-")){var[,i,s]=o.split("-").map(Number);let e,t,a,r=("interactive"===(i=currentData.story.chapters[i].paragraphs[s]).type?(t=""+headerLabel.text.interactive,e=headerLabel.emoji.interactive+" "+headerLabel.text.interactive,a="bg-interactive"):"passThru"===i.type?(t=""+headerLabel.text.passThru,e=headerLabel.emoji.passThru+" "+headerLabel.text.passThru,a="bg-passthru"):"infoBox"===i.type&&(t=""+headerLabel.text.infoBox,e=headerLabel.emoji.infoBox+" "+headerLabel.text.infoBox,a="bg-infobox"),`
      ${panelHeader}class="${a}">${e}</div>
      ${property}<strong>ID:</strong>${editableSpan}data-property="id">${i.id}</span></p>
      ${""}
      ${editableProperty}<strong>Text:</strong><br>${editableSpan}data-property="text_body"></span></p>
      ${editableProperty}<strong>Image:</strong>${editableSpan}data-property="image">${i.image}</span></p>
    `);"passThru"!==i.type&&"infoBox"!==i.type||(r+=`${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${i.destination_id||""}</span></p>`),n.innerHTML+=r;(s=document.querySelector('[data-property="text_body"]'))&&(s.textContent=i.text_body);var s=document.querySelector('[data-property="id"]'),l=document.querySelector('[data-property="destination_id"]');validateUInt(s,i.id),"infoBox"!==i.type&&validateUInt(l,i.destination_id)}else o.startsWith("choice-")&&([,s,l,i]=o.split("-").map(Number),s=currentData.story.chapters[s].paragraphs[l].choices[i],n.innerHTML+=`
      ${panelHeader}class="bg-choice">${headerLabel.emoji.choice} ${headerLabel.text.choice}</div>
      ${editableProperty}<strong>Text:</strong>${editableSpan}data-property="text_body">${s.text_body}</span></p>
      ${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${s.destination_id}</span></p>
    `,validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),s.destination_id));if(document.getElementById("closePropertiesPanel").addEventListener("click",()=>{removeHighlightFromBlocks(),togglePropertiesPanelVisibility(!1)}),document.querySelectorAll(".editable-property").forEach(e=>{var t=(e=e.querySelector(".editable")).getAttribute("data-property"),a=createEditButton(e,o,t);e.parentNode.appendChild(a),o.startsWith("paragraph-")&&"image"===t&&(a=createImagePreviewIcon(e,o,t),e.parentNode.appendChild(a))}),setupImagePreview(),(l=document.createElement("div")).classList.add("panel-buttons-container"),"story"!==o){let e=document.querySelector(`[data-id="${o}"]`);e&&"interactive"===e.dataset.type&&((i=document.createElement("button")).innerText="🎯 Add Choice",i.classList.add("new-choice-button"),i.addEventListener("click",()=>createNewChoice(e)),l.appendChild(i)),(s=document.createElement("button")).innerText="🗑️ Delete...",s.classList.add("delete-button"),s.addEventListener("click",()=>deleteBlock(o)),l.appendChild(s)}n.appendChild(l)}function updateDataFromPanel(e,t,a){var r,o,n,i;"story"===e?("typingSpeed"===t?a=Number(a):"hasInventory"===t&&(a="true"===a.toLowerCase()),currentData.story[t]=a):e.startsWith("chapter-")?(r=parseInt(e.split("-")[1]),"id"===t?(a=Number(a),currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".id-label"))&&(i.innerText="ID: "+a)):"title"===t?(currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".type-label"))&&(i.innerText=a)):currentData.story.chapters[r][t]=a):e.startsWith("paragraph-")?([,i,r]=e.split("-").map(Number),"id"===t?(a=Number(a),currentData.story.chapters[i].paragraphs[r][t]=a,(n=document.querySelector(`.block[data-id="${e}"]`))&&(n.dataset.jsonId=a,(n=n.querySelector(".id-label"))&&(n.innerText="ID: "+a),updateConnections())):"destination_id"===t?(a&&""!==a.trim()?currentData.story.chapters[i].paragraphs[r][t]=a:delete currentData.story.chapters[i].paragraphs[r][t],validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=n.querySelector(".destination-label"),n.dataset.destId=a||"",o&&(o.innerText="Destination ID: "+(a||"")),updateConnections())):"image"===t?"undefined"===a||""===a.trim()?delete currentData.story.chapters[i].paragraphs[r][t]:currentData.story.chapters[i].paragraphs[r][t]=a:"text_body"===t?(currentData.story.chapters[i].paragraphs[r][t]=a,(n=(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=Array.from(n.getElementsByClassName("textbody-label")))[o.length-1])&&(n.innerText=a)):currentData.story.chapters[i].paragraphs[r][t]=a):e.startsWith("choice-")&&([,o,n,i]=e.split("-").map(Number),currentData.story.chapters[o].paragraphs[n].choices[i][t]=a,"destination_id"===t?(r=document.querySelector(`.block[data-id="${e}"]`))&&(r.dataset.destId=a,(o=r.querySelector(".destination-label"))&&(o.innerText="Destination ID: "+a),validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),updateConnections()):"text_body"===t&&(n=document.querySelector(`.block[data-id="${e}"]`))&&(i=n.querySelector(".keyword-label"))&&(i.innerText=a))}function showConfirmationDialog(e){let t=document.getElementById("dialogOverlay"),a=document.getElementById("confirmationDialog"),r=document.getElementById("dialogCancel"),o=document.getElementById("dialogOK"),n=(t.style.display="block",a.style.display="block",()=>{t.style.display="none",a.style.display="none",s()}),i=()=>{t.style.display="none",a.style.display="none",s(),e()},s=()=>{r.removeEventListener("click",n),o.removeEventListener("click",i)};r.addEventListener("click",n),o.addEventListener("click",i)}function deleteBlock(a){showConfirmationDialog(()=>{var e=document.querySelector(`[data-id="${a}"]`);if(e){if(a.startsWith("paragraph-")){let[,n,i]=a.split("-").map(Number),e=currentData.story.chapters[n].paragraphs[i].id,t=currentData.story.chapters[n].paragraphs.splice(i,1)[0];delete paragraphBlocksByJsonId[e],t.choices&&t.choices.forEach((e,t)=>{var t=`choice-${n}-${i}-`+t,a=blocks[t];a&&(a.remove(),delete blocks[t])}),currentData.story.chapters[n].paragraphs.forEach((e,o)=>{var t,a,r;o>=i&&(t=`paragraph-${n}-`+(o+1),a=`paragraph-${n}-`+o,r=blocks[t])&&(r.setAttribute("data-id",a),blocks[a]=r,delete blocks[t],e.choices)&&e.choices.forEach((e,t)=>{var a=`choice-${n}-${o+1}-`+t,t=`choice-${n}-${o}-`+t,r=blocks[a];r&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})})}else if(a.startsWith("choice-")){let[,o,n,i]=a.split("-").map(Number);currentData.story.chapters[o].paragraphs[n].choices.splice(i,1),currentData.story.chapters[o].paragraphs[n].choices.forEach((e,t)=>{var a,r;t>=i&&(a=`choice-${o}-${n}-`+(t+1),t=`choice-${o}-${n}-`+t,r=blocks[a])&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})}delete blocks[a],e.remove(),connections=connections.filter(e=>e.from!==a&&e.to!==a),choiceConnections=choiceConnections.filter(e=>e.from!==a&&e.to!==a),updateConnections(),togglePropertiesPanelVisibility(!1)}})}function setupImagePreview(){let e=document.querySelector('[data-property="image"]');if(e){var t=e.parentElement.querySelector(".image-preview-icon");if(t){let n=document.querySelector(".image-preview-tooltip");n||((n=document.createElement("div")).className="image-preview-tooltip",document.body.appendChild(n)),t.addEventListener("mouseover",o=>{if(!isEditingImage){let r=e.textContent;if(r){let a=new Image;a.onload=()=>{n.className="image-preview-tooltip",n.style.backgroundImage=`url(${r})`,n.textContent="";var e=a.height/a.width,t=Math.min(200,a.width),e=t*e,e=(n.style.width=t+"px",n.style.height=e+"px",window.innerWidth),e=o.clientX+(t=t+10)>e;n.style.left=e?o.clientX-t+"px":o.clientX+10+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.onerror=()=>{n.className="image-preview-tooltip error",n.style.backgroundImage="none",n.textContent="⛔ Image not found",n.style.width="120px",n.style.height="20px",n.style.left=o.clientX-120+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.src=r}else n.style.display="none"}}),t.addEventListener("mouseleave",()=>{n.style.display="none"})}}}function validateUInt(e,t){e&&(/^\d+$/.test(t)?e.parentNode.style.color="black":e.parentNode.style.color="red",e.textContent=t)}function togglePropertiesPanelVisibility(e){document.getElementById("propertiesPanel").style.display=e?"block":"none"}</script><script>let jsonFileNames={default:"editor/stories/il_vecchio_pozzo_TEST.json",new:"editor/stories/the_hobbit.json"},currentData=null,blocks={},connections=[],choiceConnections=[],editor,svgCanvas,propertiesPanel,closePropertiesPanel,paragraphBlocksByJsonId={},selectionBox=null,selectionStart=null,selectedBlocks=new Set,isMultiDragging=!1,multiDragOffset=null,headerLabel={emoji:{story:"📗",chapter:"📚",interactive:"👉",passThru:"⏬",infoBox:"💡",choice:"🎯"},text:{story:"Story",chapter:"Chapter",interactive:"Interactive",passThru:"Pass-through",infoBox:"Info Box",choice:"Choice"}};function init(){editor=document.getElementById("editor"),svgCanvas=document.getElementById("svgCanvas"),(closePropertiesPanel=document.getElementById("closePropertiesPanel")).addEventListener("click",()=>{togglePropertiesPanelVisibility(!1),removeHighlightFromBlocks()}),fetchJSON(jsonFileNames.default),setupSelectionBox()}function fetchJSON(e){fetch(e).then(e=>e.json()).then(e=>{createFlowchart(currentData=e)}).catch(e=>console.error("Error loading JSON:",e))}function createFlowchart(e){let t=0;e.story.chapters.forEach(e=>{(e=150*e.paragraphs.length-30)>t&&(t=e)});var a=e.story.position?e.story.position[0]:100+(t-120)/2,r=e.story.position?e.story.position[1]:20,a=createBlock("story",headerLabel.text.story,a,r);blocks.story=a,(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.story.title,a.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText=e.story.author,a.appendChild(r);let c=null;e.story.chapters.forEach((e,s)=>{let l="chapter-"+s;e.paragraphs.forEach((e,o)=>{let n=`paragraph-${s}-`+o,i=100+150*o,t=e.position?e.position[0]:i,a=e.position?e.position[1]:300,r;"interactive"===e.type?r=headerLabel.text.interactive:"passThru"===e.type?r=headerLabel.text.passThru:"infoBox"===e.type&&(r=headerLabel.text.infoBox),t=createBlock(n,r,t,a),blocks[n]=t,connections.push({from:l,to:n}),(paragraphBlocksByJsonId[e.id]=t).dataset.jsonId=e.id,t.dataset.type=e.type,e.destination_id&&""!==e.destination_id.trim&&(t.dataset.destId=e.destination_id),0===e.id&&(c=n),createIdLabel(e.id,t),"passThru"!==e.type&&"infoBox"!==e.type||createDestIdLabel(e.destination_id,t),createTextBodyLabel(e.text_body,t),e.choices&&e.choices.forEach((e,t)=>{var a=`choice-${s}-${o}-`+t,t=i+150*t,t=e.position?e.position[0]:t,r=e.position?e.position[1]:450;(t=createBlock(a,headerLabel.text.choice,t,r)).dataset.destId=e.destination_id,blocks[a]=t,connections.push({from:n,to:a}),(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.text_body,t.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText="Destination ID: "+e.destination_id,t.appendChild(r),(t=paragraphBlocksByJsonId[e.destination_id])&&choiceConnections.push({from:a,to:getBlockId(t)})})})}),c&&connections.push({from:"story",to:c}),updateConnections(),editor.addEventListener("mousedown",e=>{let t=e.target;for(;t&&!t.classList.contains("block");)t=t.parentElement;t&&t.classList.contains("block")?(e=t.getAttribute("data-id"),0===selectedBlocks.size&&(highlightBlock(t),displayProperties(e))):(removeHighlightFromBlocks(),selectedBlocks.clear(),togglePropertiesPanelVisibility(!1))})}function getBlockId(e){return e.getAttribute("data-id")}function flashNewBlock(e){e.classList.add("flash-animation"),setTimeout(()=>{e.classList.remove("flash-animation")},1200)}function createBlock(e,t,a,r,o=!1){var n=document.createElement("div");n.classList.add("block");let i="";return t===headerLabel.text.story?(n.classList.add("story"),i=headerLabel.emoji.story):t===headerLabel.text.chapter?(n.classList.add("chapter"),i=headerLabel.emoji.chapter):t===headerLabel.text.interactive?(n.classList.add("interactive"),i=headerLabel.emoji.interactive):t===headerLabel.text.passThru?(n.classList.add("passthru"),i=headerLabel.emoji.passThru):t===headerLabel.text.infoBox?(n.classList.add("infobox"),i=headerLabel.emoji.infoBox):t===headerLabel.text.choice&&(n.classList.add("choice"),i=headerLabel.emoji.choice),t=i+" "+t,n.innerHTML=`<strong>${t}</strong>`,n.style.left=a+"px",n.style.top=r+"px",n.setAttribute("data-id",e),editor.appendChild(n),makeDraggable(n),o&&flashNewBlock(n),n}function setupMarkers(e){let r=document.createElementNS("http://www.w3.org/2000/svg","defs");function t(e,t){var a=document.createElementNS("http://www.w3.org/2000/svg","marker");a.setAttribute("id",e),a.setAttribute("markerWidth","10"),a.setAttribute("markerHeight","10"),a.setAttribute("refX","6"),a.setAttribute("refY","3"),a.setAttribute("orient","auto"),(e=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d","M0,0 L0,6 L6,3 z"),e.classList.add(t),a.appendChild(e),r.appendChild(a)}t("arrowStoryChapter","marker-story-chapter"),t("arrowChapterParagraph","marker-chapter-paragraph"),t("arrowParagraphChoice","marker-paragraph-choice"),t("arrowChoiceAll","marker-choice-all"),e.appendChild(r)}function drawConnectorChoiceToParagraph(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-choice-all"),n.setAttribute("marker-end","url(#arrowChoiceAll)"),a.appendChild(n)}function drawDestinationConnector(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-chapter-paragraph"),n.setAttribute("marker-end","url(#arrowChapterParagraph)"),a.appendChild(n)}function getMarkerUrl(e){return"story-chapter"===e?"url(#arrowStoryChapter)":"chapter-paragraph"===e?"url(#arrowChapterParagraph)":"paragraph-choice"===e?"url(#arrowParagraphChoice)":"url(#arrow)"}function drawConnection(e,t,a,r){var{x:e,y:o}=getBlockCenter(e),{x:t,y:n}=getEdgePoint(t,e,o);(e=createLine(e,o,t,n,a)).setAttribute("marker-end",getMarkerUrl(a)),r.appendChild(e)}function updateConnections(){for(;svgCanvas.firstChild;)svgCanvas.removeChild(svgCanvas.firstChild);setupMarkers(svgCanvas),connections.forEach(e=>{var t,a=blocks[e.from],e=blocks[e.to];a&&e&&(t=a.classList.contains("story")?"story-chapter":a.classList.contains("chapter")&&e.classList.contains("paragraph")?"chapter-paragraph":"paragraph-choice",drawConnection(a,e,t,svgCanvas))}),choiceConnections.forEach(e=>{var t=blocks[e.from],e=blocks[e.to];t&&e&&drawConnection(t,e,"paragraph-choice",svgCanvas)});let e=document.querySelectorAll(".block"),t=Array.from(e).filter(e=>e.classList.contains("choice")),a=Array.from(e).filter(e=>e.classList.contains("interactive")||e.classList.contains("passthru")||e.classList.contains("infobox"));t.forEach(t=>{a.forEach(e=>{t.dataset.destId===e.dataset.jsonId&&drawConnectorChoiceToParagraph(t,e,svgCanvas)})}),document.querySelectorAll(".block.passthru, .block.infobox").forEach(e=>{var t;e.dataset.destId&&(t=paragraphBlocksByJsonId[e.dataset.destId])&&drawDestinationConnector(e,t,svgCanvas)})}function createLine(e,t,a,r,o){var n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",e),n.setAttribute("x2",a),n.setAttribute("y1",t),n.setAttribute("y2",r),n.classList.add("connector-"+o),n}function getBlockCenter(e){var e=e.getBoundingClientRect(),t=editor.getBoundingClientRect();return{x:e.left-t.left+e.width/2,y:e.top-t.top+e.height/2}}function getEdgePoint(e,t,a){var e=e.getBoundingClientRect(),r=editor.getBoundingClientRect(),o=e.left-r.left+e.width/2,n=e.top-r.top+e.height/2,r=o-t;return t=n-a,a=Math.atan2(t,r),t=e.width/2,r=e.height/2,e=t/Math.abs(Math.cos(a)),t=r/Math.abs(Math.sin(a)),r=Math.min(e,t),{x:o-Math.cos(a)*r,y:n-Math.sin(a)*r}}function makeDraggable(t){let a=0,r=0,o=!1;t.addEventListener("mousedown",e=>{0<selectedBlocks.size&&(selectedBlocks.has(t)?(isMultiDragging=!0,multiDragOffset={x:e.clientX,y:e.clientY}):(selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}))),o=!0,a=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop,t.style.zIndex=1e3}),document.addEventListener("mousemove",e=>{if(o){if(isMultiDragging){let t=e.clientX-multiDragOffset.x,a=e.clientY-multiDragOffset.y;selectedBlocks.forEach(e=>{e.style.left=e.offsetLeft+t+"px",e.style.top=e.offsetTop+a+"px"}),multiDragOffset.x=e.clientX,multiDragOffset.y=e.clientY}else t.style.left=e.clientX-a+"px",t.style.top=e.clientY-r+"px";updateConnections()}}),document.addEventListener("mouseup",()=>{o&&(o=!1,isMultiDragging=!1,t.style.zIndex="")})}function highlightBlock(e){removeHighlightFromBlocks(),e.classList.add("selected")}function setupSelectionBox(){let a=!1,n=null;(n=document.createElement("div")).className="selection-box",editor.appendChild(n),editor.addEventListener("mousedown",e=>{var t;e.target!==editor&&e.target!==svgCanvas||(a=!0,t=editor.getBoundingClientRect(),selectionStart={x:e.clientX-t.left+editor.scrollLeft,y:e.clientY-t.top+editor.scrollTop},n.style.display="block",n.style.left=selectionStart.x+"px",n.style.top=selectionStart.y+"px",n.style.width="0",n.style.height="0",selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}),e.preventDefault())}),document.addEventListener("mousemove",e=>{if(a){var t=editor.getBoundingClientRect(),r=e.clientX-t.left+editor.scrollLeft,e=e.clientY-t.top+editor.scrollTop,t=Math.min(r,selectionStart.x),o=Math.min(e,selectionStart.y),r=Math.abs(r-selectionStart.x),e=Math.abs(e-selectionStart.y);n.style.left=t+"px",n.style.top=o+"px",n.style.width=r+"px",n.style.height=e+"px";let a=n.getBoundingClientRect();document.querySelectorAll(".block").forEach(e=>{var t=e.getBoundingClientRect();rectsOverlap(a,t)?(selectedBlocks.add(e),e.classList.add("multi-selected")):(selectedBlocks.delete(e),e.classList.remove("multi-selected"))})}}),document.addEventListener("mouseup",()=>{var e;a&&(a=!1,n.style.display="none",1===selectedBlocks.size)&&(displayProperties((e=selectedBlocks.values().next().value).getAttribute("data-id"),currentData),highlightBlock(e))})}function rectsOverlap(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}function findLowestAvailableId(){let t=new Set,e=(currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{t.add(e.id)})}),0);for(;t.has(e);)e++;return e}function createNewParagraph(e){var t,a,r,o,n;currentData&&currentData.story&&currentData.story.chapters&&0!==currentData.story.chapters.length?(a={id:t=findLowestAvailableId(),type:e,text_body:"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus lacinia odio vitae vestibulum vestibulum.",position:[100,100]},(r=currentData.story.chapters[0]).paragraphs.push(a),(o=createBlock(r="paragraph-0-"+(r.paragraphs.length-1),headerLabel.text[e],a.position[0],a.position[1],!0)).dataset.type=e,createIdLabel(o.dataset.jsonId=t,o),"interactive"===e?(n=a.text_body,a.text_body=n.slice(0,n.length-1)+" {keyword}"+n.slice(n.length-1)):"passThru"!==e&&"infoBox"!==e||createDestIdLabel("",o),createTextBodyLabel(a.text_body,o),blocks[r]=o,paragraphBlocksByJsonId[t]=o,updateConnections()):alert("Please load a story first!")}function createIdLabel(e,t){var a=document.createElement("div");a.classList.add("id-label"),a.innerHTML=`ID: <strong>${e}</strong>`,t.appendChild(a)}function createDestIdLabel(e,t){let a=void 0===e?"":e;(e=document.createElement("div")).classList.add("destination-label"),e.innerText="Destination ID: "+a,t.appendChild(e)}function createTextBodyLabel(e,t){var a=document.createElement("div");a.classList.add("textbody-label"),a.innerText=e,t.appendChild(a)}function cleanupOldFlowchart(e){for(var t=document.getElementById("editor").getElementsByClassName("block");t.length;)t[0].remove();var a=document.getElementById("svgCanvas");Array.from(a.childNodes).forEach(e=>{"defs"!==e.nodeName&&e.remove()}),currentData=e,paragraphBlocksByJsonId={},connections=[],choiceConnections=[]}document.addEventListener("DOMContentLoaded",()=>{init()}),window.removeHighlightFromBlocks=function(){document.querySelectorAll(".block").forEach(e=>{e.classList.remove("selected")})},document.getElementById("newBlock_Interactive").addEventListener("click",()=>createNewParagraph("interactive")),document.getElementById("newBlock_PassThru").addEventListener("click",()=>createNewParagraph("passThru")),document.getElementById("newBlock_InfoBox").addEventListener("click",()=>createNewParagraph("infoBox")),document.getElementById("playStory").addEventListener("click",function(){let t=window.open("./app/index.html","StoryPreview","width=500,height=900,resizable=yes,scrollbars=yes");t.addEventListener("load",function(){var e=JSON.stringify(currentData,null,2),e=(console.log("Sending story data to preview:",e),{storyData:e,isDebug:!1});t.postMessage(e,"*")})}),document.getElementById("saveStory").addEventListener("click",()=>{blocks.story&&(e=blocks.story,currentData.story.position=[parseInt(e.style.left,10),parseInt(e.style.top,10)]),currentData.story.chapters.forEach((e,r)=>{var t=blocks["chapter-"+r];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.paragraphs.forEach((e,a)=>{var t=blocks[`paragraph-${r}-`+a];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.choices&&e.choices.forEach((e,t)=>{(t=blocks[`choice-${r}-${a}-`+t])&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)])})})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{var t=paragraphBlocksByJsonId[e.id];(t=t&&t.querySelector('[data-property="text_body"]'))&&(e.text_body=t.innerText)})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{null!=e.destination_id&&""!==String(e.destination_id).trim()||(console.error("ATTENTION! There is an empty/null/undefined 'destination_id' in the data structure (currentData) that I had to remove. Make sure that empty/null/undefined 'destination_id's never get added to currentData in the first place!"),delete e.destination_id)})});var e=JSON.stringify(currentData,null,2),e=(console.log("Generated Story JSON:",e),new Blob([e],{type:"application/json"})),t=document.createElement("a"),a=currentData.story.title.toLowerCase().replace(/ /g,"_");t.download=a+".json",t.href=URL.createObjectURL(e),document.body.appendChild(t),t.click(),document.body.removeChild(t)}),document.getElementById("newStory").addEventListener("click",async()=>{try{var e=await fetch(jsonFileNames.new);if(!e.ok)throw new Error("Failed to load new JSON template");var t=await e.json();cleanupOldFlowchart(t),createFlowchart(t)}catch(e){console.error("Error creating new story:",e),alert("Error creating new story. Please check if the template file exists.")}}),document.getElementById("loadStory").addEventListener("click",()=>{document.getElementById("fileInput").click()}),document.getElementById("fileInput").addEventListener("change",a=>{var e,t=a.target.files[0];t&&((e=new FileReader).onload=function(e){try{var t=JSON.parse(e.target.result);cleanupOldFlowchart(t),createFlowchart(t),a.target.value=""}catch(e){console.error("Error loading story:",e),alert("Error loading story. Please select a valid JSON file.")}},e.readAsText(t))});let panelHeader="<div id='bg-header' ",panelInfo="<p class='panel-info'>",property="<p class='property'>",editableProperty="<p class='property editable-property'>",editableSpan=" <span class='editable' ",isEditingImage=!1;function calculateTextareaRows(e){return e=Math.ceil(e.length/30),Math.min(Math.max(e,3),30)}function createImagePreviewIcon(e,t,a){var r=document.createElement("span");return r.textContent="👁‍🗨",r.className="image-preview-icon",r}function createEditButton(t,a,r){let o=document.createElement("button");return o.textContent="📝",o.className="edit-save-button",o.onclick=e=>{e.stopPropagation(),startEditing(t,a,r,o)},o}function createSaveButton(t,a,r,o){let n=document.createElement("button");return n.textContent="💾",n.className="edit-save-button",n.onclick=e=>{e.stopPropagation(),commitChanges(t,a,r,o,n)},n}function startEditing(t,a,r,e){let o=a.startsWith("paragraph-")&&("text_body"===r||"image"===r);var n;"image"===r&&(isEditingImage=!0,n=document.querySelector(".image-preview-tooltip"))&&(n.style.display="none");let i,s=(o?(i=document.createElement("textarea")).className="property-textarea":((i=document.createElement("input")).className="property-input",n=document.getElementById("propertiesPanel").offsetWidth,i.style.width=n-65+"px"),i.value=t.innerText,t.style.display="none",t.parentNode.style.backgroundColor="#f5ffba",t.parentNode.insertBefore(i,t),createSaveButton(t,a,r,i));e.replaceWith(s),o?(n=calculateTextareaRows(t.innerText),i.rows=n):i.select(),i.focus(),i.addEventListener("keydown",function(e){("Enter"===e.key&&!o||"Enter"===e.key&&e.ctrlKey&&o)&&commitChanges(t,a,r,i,s)})}function commitChanges(e,t,a,r,o){e.innerText=r.value,updateDataFromPanel(t,a,r.value),e.parentNode.style.backgroundColor="#fdfdfd",r.remove(),r=createEditButton(e,t,a),o.replaceWith(r),"image"===a?(e.style.display="block",isEditingImage=!1):e.style.display="inline"}function addNewChoiceButton(e,t){var a,r;"interactive"===e.dataset.type&&((a=document.createElement("div")).classList.add("new-choice-container"),(r=document.createElement("button")).innerText="🎯 Add Choice",r.classList.add("new-choice-button"),r.addEventListener("click",()=>createNewChoice(e)),a.appendChild(r),propertiesPanel.appendChild(a))}function createNewChoice(e){let r=e.dataset.jsonId,o,n,i;var t,a,s,l;currentData.story.chapters.forEach((e,a)=>{e.paragraphs.forEach((e,t)=>{e.id.toString()===r&&(o=e,n=a,i=t)})}),o&&(o.choices||(o.choices=[]),t={text_body:"New Choice",destination_id:"",position:[parseInt(e.style.left)+150,parseInt(e.style.top)+150]},o.choices.push(t),(s=createBlock(a=`choice-${n}-${i}-`+(o.choices.length-1),"Choice",t.position[0],t.position[1],!0)).dataset.destId=t.destination_id,blocks[a]=s,(l=document.createElement("div")).classList.add("keyword-label"),l.innerText=t.text_body,s.appendChild(l),(l=document.createElement("div")).classList.add("destination-label"),l.innerText="Destination ID: "+t.destination_id,s.appendChild(l),connections.push({from:getBlockId(e),to:a}),updateConnections())}function displayProperties(o){var n=document.getElementById("propertiesPanel");if(n.innerHTML='<button id="closePropertiesPanel" class="close-button">X</button>',togglePropertiesPanelVisibility(!0),"story"===o){let e=`
      ${panelHeader}class="bg-story">${headerLabel.emoji.story} ${headerLabel.text.story}</div>
      ${editableProperty}<strong>Title:</strong>${editableSpan}data-property="title">${currentData.story.title}</span></p>
      ${editableProperty}<strong>Author:</strong>${editableSpan}data-property="author">${currentData.story.author}</span></p>
      ${editableProperty}<strong>Date:</strong>${editableSpan}data-property="date">${currentData.story.date}</span></p>
    `;currentData.story.stylesheet&&(e+=`${editableProperty}<strong>Style Sheet:</strong>${editableSpan}data-property="stylesheet">${currentData.story.stylesheet}</span></p>`),currentData.story.typingSpeed&&(e+=`${editableProperty}<strong>Typing Speed:</strong>${editableSpan}data-property="typingSpeed">${currentData.story.typingSpeed}</span></p>`),void 0!==currentData.story.hasInventory&&(e+=`${editableProperty}<strong>Has Inventory:</strong>${editableSpan}data-property="hasInventory">${currentData.story.hasInventory}</span></p>`),currentData.story.hasInventory&&(e=(e+=`${editableProperty}<strong>Inventory Name:</strong>${editableSpan}data-property="inventoryName">${currentData.story.inventoryName}</span></p>`)+`${editableProperty}<strong>Inventory Empty:</strong>${editableSpan}data-property="inventoryEmpty">${currentData.story.inventoryEmpty}</span></p>`),n.innerHTML+=e}else if(o.startsWith("chapter-")){var i=parseInt(o.split("-")[1]),i=(currentData.story.chapters[i],`
      ${panelHeader}class="bg-chapter">${headerLabel.emoji.chapter} ${headerLabel.text.chapter}</div>
    `);n.innerHTML+=i}else if(o.startsWith("paragraph-")){var[,i,s]=o.split("-").map(Number);let e,t,a,r=("interactive"===(i=currentData.story.chapters[i].paragraphs[s]).type?(t=""+headerLabel.text.interactive,e=headerLabel.emoji.interactive+" "+headerLabel.text.interactive,a="bg-interactive"):"passThru"===i.type?(t=""+headerLabel.text.passThru,e=headerLabel.emoji.passThru+" "+headerLabel.text.passThru,a="bg-passthru"):"infoBox"===i.type&&(t=""+headerLabel.text.infoBox,e=headerLabel.emoji.infoBox+" "+headerLabel.text.infoBox,a="bg-infobox"),`
      ${panelHeader}class="${a}">${e}</div>
      ${property}<strong>ID:</strong>${editableSpan}data-property="id">${i.id}</span></p>
      ${""}
      ${editableProperty}<strong>Text:</strong><br>${editableSpan}data-property="text_body"></span></p>
      ${editableProperty}<strong>Image:</strong>${editableSpan}data-property="image">${i.image}</span></p>
    `);"passThru"!==i.type&&"infoBox"!==i.type||(r+=`${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${i.destination_id||""}</span></p>`),n.innerHTML+=r;(s=document.querySelector('[data-property="text_body"]'))&&(s.textContent=i.text_body);var s=document.querySelector('[data-property="id"]'),l=document.querySelector('[data-property="destination_id"]');validateUInt(s,i.id),"infoBox"!==i.type&&validateUInt(l,i.destination_id)}else o.startsWith("choice-")&&([,s,l,i]=o.split("-").map(Number),s=currentData.story.chapters[s].paragraphs[l].choices[i],n.innerHTML+=`
      ${panelHeader}class="bg-choice">${headerLabel.emoji.choice} ${headerLabel.text.choice}</div>
      ${editableProperty}<strong>Text:</strong>${editableSpan}data-property="text_body">${s.text_body}</span></p>
      ${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${s.destination_id}</span></p>
    `,validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),s.destination_id));if(document.getElementById("closePropertiesPanel").addEventListener("click",()=>{removeHighlightFromBlocks(),togglePropertiesPanelVisibility(!1)}),document.querySelectorAll(".editable-property").forEach(e=>{var t=(e=e.querySelector(".editable")).getAttribute("data-property"),a=createEditButton(e,o,t);e.parentNode.appendChild(a),o.startsWith("paragraph-")&&"image"===t&&(a=createImagePreviewIcon(e,o,t),e.parentNode.appendChild(a))}),setupImagePreview(),(l=document.createElement("div")).classList.add("panel-buttons-container"),"story"!==o){let e=document.querySelector(`[data-id="${o}"]`);e&&"interactive"===e.dataset.type&&((i=document.createElement("button")).innerText="🎯 Add Choice",i.classList.add("new-choice-button"),i.addEventListener("click",()=>createNewChoice(e)),l.appendChild(i)),(s=document.createElement("button")).innerText="🗑️ Delete...",s.classList.add("delete-button"),s.addEventListener("click",()=>deleteBlock(o)),l.appendChild(s)}n.appendChild(l)}function updateDataFromPanel(e,t,a){var r,o,n,i;"story"===e?("typingSpeed"===t?a=Number(a):"hasInventory"===t&&(a="true"===a.toLowerCase()),currentData.story[t]=a):e.startsWith("chapter-")?(r=parseInt(e.split("-")[1]),"id"===t?(a=Number(a),currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".id-label"))&&(i.innerText="ID: "+a)):"title"===t?(currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".type-label"))&&(i.innerText=a)):currentData.story.chapters[r][t]=a):e.startsWith("paragraph-")?([,i,r]=e.split("-").map(Number),"id"===t?(a=Number(a),currentData.story.chapters[i].paragraphs[r][t]=a,(n=document.querySelector(`.block[data-id="${e}"]`))&&(n.dataset.jsonId=a,(n=n.querySelector(".id-label"))&&(n.innerText="ID: "+a),updateConnections())):"destination_id"===t?(a&&""!==a.trim()?currentData.story.chapters[i].paragraphs[r][t]=a:delete currentData.story.chapters[i].paragraphs[r][t],validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=n.querySelector(".destination-label"),n.dataset.destId=a||"",o&&(o.innerText="Destination ID: "+(a||"")),updateConnections())):"image"===t?"undefined"===a||""===a.trim()?delete currentData.story.chapters[i].paragraphs[r][t]:currentData.story.chapters[i].paragraphs[r][t]=a:"text_body"===t?(currentData.story.chapters[i].paragraphs[r][t]=a,(n=(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=Array.from(n.getElementsByClassName("textbody-label")))[o.length-1])&&(n.innerText=a)):currentData.story.chapters[i].paragraphs[r][t]=a):e.startsWith("choice-")&&([,o,n,i]=e.split("-").map(Number),currentData.story.chapters[o].paragraphs[n].choices[i][t]=a,"destination_id"===t?(r=document.querySelector(`.block[data-id="${e}"]`))&&(r.dataset.destId=a,(o=r.querySelector(".destination-label"))&&(o.innerText="Destination ID: "+a),validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),updateConnections()):"text_body"===t&&(n=document.querySelector(`.block[data-id="${e}"]`))&&(i=n.querySelector(".keyword-label"))&&(i.innerText=a))}function showConfirmationDialog(e){let t=document.getElementById("dialogOverlay"),a=document.getElementById("confirmationDialog"),r=document.getElementById("dialogCancel"),o=document.getElementById("dialogOK"),n=(t.style.display="block",a.style.display="block",()=>{t.style.display="none",a.style.display="none",s()}),i=()=>{t.style.display="none",a.style.display="none",s(),e()},s=()=>{r.removeEventListener("click",n),o.removeEventListener("click",i)};r.addEventListener("click",n),o.addEventListener("click",i)}function deleteBlock(a){showConfirmationDialog(()=>{var e=document.querySelector(`[data-id="${a}"]`);if(e){if(a.startsWith("paragraph-")){let[,n,i]=a.split("-").map(Number),e=currentData.story.chapters[n].paragraphs[i].id,t=currentData.story.chapters[n].paragraphs.splice(i,1)[0];delete paragraphBlocksByJsonId[e],t.choices&&t.choices.forEach((e,t)=>{var t=`choice-${n}-${i}-`+t,a=blocks[t];a&&(a.remove(),delete blocks[t])}),currentData.story.chapters[n].paragraphs.forEach((e,o)=>{var t,a,r;o>=i&&(t=`paragraph-${n}-`+(o+1),a=`paragraph-${n}-`+o,r=blocks[t])&&(r.setAttribute("data-id",a),blocks[a]=r,delete blocks[t],e.choices)&&e.choices.forEach((e,t)=>{var a=`choice-${n}-${o+1}-`+t,t=`choice-${n}-${o}-`+t,r=blocks[a];r&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})})}else if(a.startsWith("choice-")){let[,o,n,i]=a.split("-").map(Number);currentData.story.chapters[o].paragraphs[n].choices.splice(i,1),currentData.story.chapters[o].paragraphs[n].choices.forEach((e,t)=>{var a,r;t>=i&&(a=`choice-${o}-${n}-`+(t+1),t=`choice-${o}-${n}-`+t,r=blocks[a])&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})}delete blocks[a],e.remove(),connections=connections.filter(e=>e.from!==a&&e.to!==a),choiceConnections=choiceConnections.filter(e=>e.from!==a&&e.to!==a),updateConnections(),togglePropertiesPanelVisibility(!1)}})}function setupImagePreview(){let e=document.querySelector('[data-property="image"]');if(e){var t=e.parentElement.querySelector(".image-preview-icon");if(t){let n=document.querySelector(".image-preview-tooltip");n||((n=document.createElement("div")).className="image-preview-tooltip",document.body.appendChild(n)),t.addEventListener("mouseover",o=>{if(!isEditingImage){let r=e.textContent;if(r){let a=new Image;a.onload=()=>{n.className="image-preview-tooltip",n.style.backgroundImage=`url(${r})`,n.textContent="";var e=a.height/a.width,t=Math.min(200,a.width),e=t*e,e=(n.style.width=t+"px",n.style.height=e+"px",window.innerWidth),e=o.clientX+(t=t+10)>e;n.style.left=e?o.clientX-t+"px":o.clientX+10+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.onerror=()=>{n.className="image-preview-tooltip error",n.style.backgroundImage="none",n.textContent="⛔ Image not found",n.style.width="120px",n.style.height="20px",n.style.left=o.clientX-120+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.src=r}else n.style.display="none"}}),t.addEventListener("mouseleave",()=>{n.style.display="none"})}}}function validateUInt(e,t){e&&(/^\d+$/.test(t)?e.parentNode.style.color="black":e.parentNode.style.color="red",e.textContent=t)}function togglePropertiesPanelVisibility(e){document.getElementById("propertiesPanel").style.display=e?"block":"none"}</script><script>let jsonFileNames={default:"editor/stories/il_vecchio_pozzo_TEST.json",new:"editor/stories/the_hobbit.json"},currentData=null,blocks={},connections=[],choiceConnections=[],editor,svgCanvas,propertiesPanel,closePropertiesPanel,paragraphBlocksByJsonId={},selectionBox=null,selectionStart=null,selectedBlocks=new Set,isMultiDragging=!1,multiDragOffset=null,headerLabel={emoji:{story:"📗",chapter:"📚",interactive:"👉",passThru:"⏬",infoBox:"💡",choice:"🎯"},text:{story:"Story",chapter:"Chapter",interactive:"Interactive",passThru:"Pass-through",infoBox:"Info Box",choice:"Choice"}};function init(){editor=document.getElementById("editor"),svgCanvas=document.getElementById("svgCanvas"),(closePropertiesPanel=document.getElementById("closePropertiesPanel")).addEventListener("click",()=>{togglePropertiesPanelVisibility(!1),removeHighlightFromBlocks()}),fetchJSON(jsonFileNames.default),setupSelectionBox()}function fetchJSON(e){fetch(e).then(e=>e.json()).then(e=>{createFlowchart(currentData=e)}).catch(e=>console.error("Error loading JSON:",e))}function createFlowchart(e){let t=0;e.story.chapters.forEach(e=>{(e=150*e.paragraphs.length-30)>t&&(t=e)});var a=e.story.position?e.story.position[0]:100+(t-120)/2,r=e.story.position?e.story.position[1]:20,a=createBlock("story",headerLabel.text.story,a,r);blocks.story=a,(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.story.title,a.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText=e.story.author,a.appendChild(r);let c=null;e.story.chapters.forEach((e,s)=>{let l="chapter-"+s;e.paragraphs.forEach((e,o)=>{let n=`paragraph-${s}-`+o,i=100+150*o,t=e.position?e.position[0]:i,a=e.position?e.position[1]:300,r;"interactive"===e.type?r=headerLabel.text.interactive:"passThru"===e.type?r=headerLabel.text.passThru:"infoBox"===e.type&&(r=headerLabel.text.infoBox),t=createBlock(n,r,t,a),blocks[n]=t,connections.push({from:l,to:n}),(paragraphBlocksByJsonId[e.id]=t).dataset.jsonId=e.id,t.dataset.type=e.type,e.destination_id&&""!==e.destination_id.trim&&(t.dataset.destId=e.destination_id),0===e.id&&(c=n),createIdLabel(e.id,t),"passThru"!==e.type&&"infoBox"!==e.type||createDestIdLabel(e.destination_id,t),createTextBodyLabel(e.text_body,t),e.choices&&e.choices.forEach((e,t)=>{var a=`choice-${s}-${o}-`+t,t=i+150*t,t=e.position?e.position[0]:t,r=e.position?e.position[1]:450;(t=createBlock(a,headerLabel.text.choice,t,r)).dataset.destId=e.destination_id,blocks[a]=t,connections.push({from:n,to:a}),(r=document.createElement("div")).classList.add("keyword-label"),r.innerText=e.text_body,t.appendChild(r),(r=document.createElement("div")).classList.add("destination-label"),r.innerText="Destination ID: "+e.destination_id,t.appendChild(r),(t=paragraphBlocksByJsonId[e.destination_id])&&choiceConnections.push({from:a,to:getBlockId(t)})})})}),c&&connections.push({from:"story",to:c}),updateConnections(),editor.addEventListener("mousedown",e=>{let t=e.target;for(;t&&!t.classList.contains("block");)t=t.parentElement;t&&t.classList.contains("block")?(e=t.getAttribute("data-id"),0===selectedBlocks.size&&(highlightBlock(t),displayProperties(e))):(removeHighlightFromBlocks(),selectedBlocks.clear(),togglePropertiesPanelVisibility(!1))})}function getBlockId(e){return e.getAttribute("data-id")}function flashNewBlock(e){e.classList.add("flash-animation"),setTimeout(()=>{e.classList.remove("flash-animation")},1200)}function createBlock(e,t,a,r,o=!1){var n=document.createElement("div");n.classList.add("block");let i="";return t===headerLabel.text.story?(n.classList.add("story"),i=headerLabel.emoji.story):t===headerLabel.text.chapter?(n.classList.add("chapter"),i=headerLabel.emoji.chapter):t===headerLabel.text.interactive?(n.classList.add("interactive"),i=headerLabel.emoji.interactive):t===headerLabel.text.passThru?(n.classList.add("passthru"),i=headerLabel.emoji.passThru):t===headerLabel.text.infoBox?(n.classList.add("infobox"),i=headerLabel.emoji.infoBox):t===headerLabel.text.choice&&(n.classList.add("choice"),i=headerLabel.emoji.choice),t=i+" "+t,n.innerHTML=`<strong>${t}</strong>`,n.style.left=a+"px",n.style.top=r+"px",n.setAttribute("data-id",e),editor.appendChild(n),makeDraggable(n),o&&flashNewBlock(n),n}function setupMarkers(e){let r=document.createElementNS("http://www.w3.org/2000/svg","defs");function t(e,t){var a=document.createElementNS("http://www.w3.org/2000/svg","marker");a.setAttribute("id",e),a.setAttribute("markerWidth","10"),a.setAttribute("markerHeight","10"),a.setAttribute("refX","6"),a.setAttribute("refY","3"),a.setAttribute("orient","auto"),(e=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d","M0,0 L0,6 L6,3 z"),e.classList.add(t),a.appendChild(e),r.appendChild(a)}t("arrowStoryChapter","marker-story-chapter"),t("arrowChapterParagraph","marker-chapter-paragraph"),t("arrowParagraphChoice","marker-paragraph-choice"),t("arrowChoiceAll","marker-choice-all"),e.appendChild(r)}function drawConnectorChoiceToParagraph(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-choice-all"),n.setAttribute("marker-end","url(#arrowChoiceAll)"),a.appendChild(n)}function drawDestinationConnector(e,t,a){var{x:e,y:r}=getBlockCenter(e),{x:t,y:o}=getEdgePoint(t,e,r),n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",t),n.setAttribute("y2",o),n.classList.add("connector-chapter-paragraph"),n.setAttribute("marker-end","url(#arrowChapterParagraph)"),a.appendChild(n)}function getMarkerUrl(e){return"story-chapter"===e?"url(#arrowStoryChapter)":"chapter-paragraph"===e?"url(#arrowChapterParagraph)":"paragraph-choice"===e?"url(#arrowParagraphChoice)":"url(#arrow)"}function drawConnection(e,t,a,r){var{x:e,y:o}=getBlockCenter(e),{x:t,y:n}=getEdgePoint(t,e,o);(e=createLine(e,o,t,n,a)).setAttribute("marker-end",getMarkerUrl(a)),r.appendChild(e)}function updateConnections(){for(;svgCanvas.firstChild;)svgCanvas.removeChild(svgCanvas.firstChild);setupMarkers(svgCanvas),connections.forEach(e=>{var t,a=blocks[e.from],e=blocks[e.to];a&&e&&(t=a.classList.contains("story")?"story-chapter":a.classList.contains("chapter")&&e.classList.contains("paragraph")?"chapter-paragraph":"paragraph-choice",drawConnection(a,e,t,svgCanvas))}),choiceConnections.forEach(e=>{var t=blocks[e.from],e=blocks[e.to];t&&e&&drawConnection(t,e,"paragraph-choice",svgCanvas)});let e=document.querySelectorAll(".block"),t=Array.from(e).filter(e=>e.classList.contains("choice")),a=Array.from(e).filter(e=>e.classList.contains("interactive")||e.classList.contains("passthru")||e.classList.contains("infobox"));t.forEach(t=>{a.forEach(e=>{t.dataset.destId===e.dataset.jsonId&&drawConnectorChoiceToParagraph(t,e,svgCanvas)})}),document.querySelectorAll(".block.passthru, .block.infobox").forEach(e=>{var t;e.dataset.destId&&(t=paragraphBlocksByJsonId[e.dataset.destId])&&drawDestinationConnector(e,t,svgCanvas)})}function createLine(e,t,a,r,o){var n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",e),n.setAttribute("x2",a),n.setAttribute("y1",t),n.setAttribute("y2",r),n.classList.add("connector-"+o),n}function getBlockCenter(e){var e=e.getBoundingClientRect(),t=editor.getBoundingClientRect();return{x:e.left-t.left+e.width/2,y:e.top-t.top+e.height/2}}function getEdgePoint(e,t,a){var e=e.getBoundingClientRect(),r=editor.getBoundingClientRect(),o=e.left-r.left+e.width/2,n=e.top-r.top+e.height/2,r=o-t;return t=n-a,a=Math.atan2(t,r),t=e.width/2,r=e.height/2,e=t/Math.abs(Math.cos(a)),t=r/Math.abs(Math.sin(a)),r=Math.min(e,t),{x:o-Math.cos(a)*r,y:n-Math.sin(a)*r}}function makeDraggable(t){let a=0,r=0,o=!1;t.addEventListener("mousedown",e=>{0<selectedBlocks.size&&(selectedBlocks.has(t)?(isMultiDragging=!0,multiDragOffset={x:e.clientX,y:e.clientY}):(selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}))),o=!0,a=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop,t.style.zIndex=1e3}),document.addEventListener("mousemove",e=>{if(o){if(isMultiDragging){let t=e.clientX-multiDragOffset.x,a=e.clientY-multiDragOffset.y;selectedBlocks.forEach(e=>{e.style.left=e.offsetLeft+t+"px",e.style.top=e.offsetTop+a+"px"}),multiDragOffset.x=e.clientX,multiDragOffset.y=e.clientY}else t.style.left=e.clientX-a+"px",t.style.top=e.clientY-r+"px";updateConnections()}}),document.addEventListener("mouseup",()=>{o&&(o=!1,isMultiDragging=!1,t.style.zIndex="")})}function highlightBlock(e){removeHighlightFromBlocks(),e.classList.add("selected")}function setupSelectionBox(){let a=!1,n=null;(n=document.createElement("div")).className="selection-box",editor.appendChild(n),editor.addEventListener("mousedown",e=>{var t;e.target!==editor&&e.target!==svgCanvas||(a=!0,t=editor.getBoundingClientRect(),selectionStart={x:e.clientX-t.left+editor.scrollLeft,y:e.clientY-t.top+editor.scrollTop},n.style.display="block",n.style.left=selectionStart.x+"px",n.style.top=selectionStart.y+"px",n.style.width="0",n.style.height="0",selectedBlocks.clear(),document.querySelectorAll(".block").forEach(e=>{e.classList.remove("multi-selected")}),e.preventDefault())}),document.addEventListener("mousemove",e=>{if(a){var t=editor.getBoundingClientRect(),r=e.clientX-t.left+editor.scrollLeft,e=e.clientY-t.top+editor.scrollTop,t=Math.min(r,selectionStart.x),o=Math.min(e,selectionStart.y),r=Math.abs(r-selectionStart.x),e=Math.abs(e-selectionStart.y);n.style.left=t+"px",n.style.top=o+"px",n.style.width=r+"px",n.style.height=e+"px";let a=n.getBoundingClientRect();document.querySelectorAll(".block").forEach(e=>{var t=e.getBoundingClientRect();rectsOverlap(a,t)?(selectedBlocks.add(e),e.classList.add("multi-selected")):(selectedBlocks.delete(e),e.classList.remove("multi-selected"))})}}),document.addEventListener("mouseup",()=>{var e;a&&(a=!1,n.style.display="none",1===selectedBlocks.size)&&(displayProperties((e=selectedBlocks.values().next().value).getAttribute("data-id"),currentData),highlightBlock(e))})}function rectsOverlap(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}function findLowestAvailableId(){let t=new Set,e=(currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{t.add(e.id)})}),0);for(;t.has(e);)e++;return e}function createNewParagraph(e){var t,a,r,o,n;currentData&&currentData.story&&currentData.story.chapters&&0!==currentData.story.chapters.length?(a={id:t=findLowestAvailableId(),type:e,text_body:"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus lacinia odio vitae vestibulum vestibulum.",position:[100,100]},(r=currentData.story.chapters[0]).paragraphs.push(a),(o=createBlock(r="paragraph-0-"+(r.paragraphs.length-1),headerLabel.text[e],a.position[0],a.position[1],!0)).dataset.type=e,createIdLabel(o.dataset.jsonId=t,o),"interactive"===e?(n=a.text_body,a.text_body=n.slice(0,n.length-1)+" {keyword}"+n.slice(n.length-1)):"passThru"!==e&&"infoBox"!==e||createDestIdLabel("",o),createTextBodyLabel(a.text_body,o),blocks[r]=o,paragraphBlocksByJsonId[t]=o,updateConnections()):alert("Please load a story first!")}function createIdLabel(e,t){var a=document.createElement("div");a.classList.add("id-label"),a.innerHTML=`ID: <strong>${e}</strong>`,t.appendChild(a)}function createDestIdLabel(e,t){let a=void 0===e?"":e;(e=document.createElement("div")).classList.add("destination-label"),e.innerText="Destination ID: "+a,t.appendChild(e)}function createTextBodyLabel(e,t){var a=document.createElement("div");a.classList.add("textbody-label"),a.innerText=e,t.appendChild(a)}function cleanupOldFlowchart(e){for(var t=document.getElementById("editor").getElementsByClassName("block");t.length;)t[0].remove();var a=document.getElementById("svgCanvas");Array.from(a.childNodes).forEach(e=>{"defs"!==e.nodeName&&e.remove()}),currentData=e,paragraphBlocksByJsonId={},connections=[],choiceConnections=[]}document.addEventListener("DOMContentLoaded",()=>{init()}),window.removeHighlightFromBlocks=function(){document.querySelectorAll(".block").forEach(e=>{e.classList.remove("selected")})},document.getElementById("newBlock_Interactive").addEventListener("click",()=>createNewParagraph("interactive")),document.getElementById("newBlock_PassThru").addEventListener("click",()=>createNewParagraph("passThru")),document.getElementById("newBlock_InfoBox").addEventListener("click",()=>createNewParagraph("infoBox")),document.getElementById("playStory").addEventListener("click",function(){let t=window.open("./app/index.html","StoryPreview","width=500,height=900,resizable=yes,scrollbars=yes");t.addEventListener("load",function(){var e=JSON.stringify(currentData,null,2),e=(console.log("Sending story data to preview:",e),{storyData:e,isDebug:!1});t.postMessage(e,"*")})}),document.getElementById("saveStory").addEventListener("click",()=>{blocks.story&&(e=blocks.story,currentData.story.position=[parseInt(e.style.left,10),parseInt(e.style.top,10)]),currentData.story.chapters.forEach((e,r)=>{var t=blocks["chapter-"+r];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.paragraphs.forEach((e,a)=>{var t=blocks[`paragraph-${r}-`+a];t&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)]),e.choices&&e.choices.forEach((e,t)=>{(t=blocks[`choice-${r}-${a}-`+t])&&(e.position=[parseInt(t.style.left,10),parseInt(t.style.top,10)])})})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{var t=paragraphBlocksByJsonId[e.id];(t=t&&t.querySelector('[data-property="text_body"]'))&&(e.text_body=t.innerText)})}),currentData.story.chapters.forEach(e=>{e.paragraphs.forEach(e=>{null!=e.destination_id&&""!==String(e.destination_id).trim()||(console.error("ATTENTION! There is an empty/null/undefined 'destination_id' in the data structure (currentData) that I had to remove. Make sure that empty/null/undefined 'destination_id's never get added to currentData in the first place!"),delete e.destination_id)})});var e=JSON.stringify(currentData,null,2),e=(console.log("Generated Story JSON:",e),new Blob([e],{type:"application/json"})),t=document.createElement("a"),a=currentData.story.title.toLowerCase().replace(/ /g,"_");t.download=a+".json",t.href=URL.createObjectURL(e),document.body.appendChild(t),t.click(),document.body.removeChild(t)}),document.getElementById("newStory").addEventListener("click",async()=>{try{var e=await fetch(jsonFileNames.new);if(!e.ok)throw new Error("Failed to load new JSON template");var t=await e.json();cleanupOldFlowchart(t),createFlowchart(t)}catch(e){console.error("Error creating new story:",e),alert("Error creating new story. Please check if the template file exists.")}}),document.getElementById("loadStory").addEventListener("click",()=>{document.getElementById("fileInput").click()}),document.getElementById("fileInput").addEventListener("change",a=>{var e,t=a.target.files[0];t&&((e=new FileReader).onload=function(e){try{var t=JSON.parse(e.target.result);cleanupOldFlowchart(t),createFlowchart(t),a.target.value=""}catch(e){console.error("Error loading story:",e),alert("Error loading story. Please select a valid JSON file.")}},e.readAsText(t))});let panelHeader="<div id='bg-header' ",panelInfo="<p class='panel-info'>",property="<p class='property'>",editableProperty="<p class='property editable-property'>",editableSpan=" <span class='editable' ",isEditingImage=!1;function calculateTextareaRows(e){return e=Math.ceil(e.length/30),Math.min(Math.max(e,3),30)}function createImagePreviewIcon(e,t,a){var r=document.createElement("span");return r.textContent="👁‍🗨",r.className="image-preview-icon",r}function createEditButton(t,a,r){let o=document.createElement("button");return o.textContent="📝",o.className="edit-save-button",o.onclick=e=>{e.stopPropagation(),startEditing(t,a,r,o)},o}function createSaveButton(t,a,r,o){let n=document.createElement("button");return n.textContent="💾",n.className="edit-save-button",n.onclick=e=>{e.stopPropagation(),commitChanges(t,a,r,o,n)},n}function startEditing(t,a,r,e){let o=a.startsWith("paragraph-")&&("text_body"===r||"image"===r);var n;"image"===r&&(isEditingImage=!0,n=document.querySelector(".image-preview-tooltip"))&&(n.style.display="none");let i,s=(o?(i=document.createElement("textarea")).className="property-textarea":((i=document.createElement("input")).className="property-input",n=document.getElementById("propertiesPanel").offsetWidth,i.style.width=n-65+"px"),i.value=t.innerText,t.style.display="none",t.parentNode.style.backgroundColor="#f5ffba",t.parentNode.insertBefore(i,t),createSaveButton(t,a,r,i));e.replaceWith(s),o?(n=calculateTextareaRows(t.innerText),i.rows=n):i.select(),i.focus(),i.addEventListener("keydown",function(e){("Enter"===e.key&&!o||"Enter"===e.key&&e.ctrlKey&&o)&&commitChanges(t,a,r,i,s)})}function commitChanges(e,t,a,r,o){e.innerText=r.value,updateDataFromPanel(t,a,r.value),e.parentNode.style.backgroundColor="#fdfdfd",r.remove(),r=createEditButton(e,t,a),o.replaceWith(r),"image"===a?(e.style.display="block",isEditingImage=!1):e.style.display="inline"}function addNewChoiceButton(e,t){var a,r;"interactive"===e.dataset.type&&((a=document.createElement("div")).classList.add("new-choice-container"),(r=document.createElement("button")).innerText="🎯 Add Choice",r.classList.add("new-choice-button"),r.addEventListener("click",()=>createNewChoice(e)),a.appendChild(r),propertiesPanel.appendChild(a))}function createNewChoice(e){let r=e.dataset.jsonId,o,n,i;var t,a,s,l;currentData.story.chapters.forEach((e,a)=>{e.paragraphs.forEach((e,t)=>{e.id.toString()===r&&(o=e,n=a,i=t)})}),o&&(o.choices||(o.choices=[]),t={text_body:"New Choice",destination_id:"",position:[parseInt(e.style.left)+150,parseInt(e.style.top)+150]},o.choices.push(t),(s=createBlock(a=`choice-${n}-${i}-`+(o.choices.length-1),"Choice",t.position[0],t.position[1],!0)).dataset.destId=t.destination_id,blocks[a]=s,(l=document.createElement("div")).classList.add("keyword-label"),l.innerText=t.text_body,s.appendChild(l),(l=document.createElement("div")).classList.add("destination-label"),l.innerText="Destination ID: "+t.destination_id,s.appendChild(l),connections.push({from:getBlockId(e),to:a}),updateConnections())}function displayProperties(o){var n=document.getElementById("propertiesPanel");if(n.innerHTML='<button id="closePropertiesPanel" class="close-button">X</button>',togglePropertiesPanelVisibility(!0),"story"===o){let e=`
      ${panelHeader}class="bg-story">${headerLabel.emoji.story} ${headerLabel.text.story}</div>
      ${editableProperty}<strong>Title:</strong>${editableSpan}data-property="title">${currentData.story.title}</span></p>
      ${editableProperty}<strong>Author:</strong>${editableSpan}data-property="author">${currentData.story.author}</span></p>
      ${editableProperty}<strong>Date:</strong>${editableSpan}data-property="date">${currentData.story.date}</span></p>
    `;currentData.story.stylesheet&&(e+=`${editableProperty}<strong>Style Sheet:</strong>${editableSpan}data-property="stylesheet">${currentData.story.stylesheet}</span></p>`),currentData.story.typingSpeed&&(e+=`${editableProperty}<strong>Typing Speed:</strong>${editableSpan}data-property="typingSpeed">${currentData.story.typingSpeed}</span></p>`),void 0!==currentData.story.hasInventory&&(e+=`${editableProperty}<strong>Has Inventory:</strong>${editableSpan}data-property="hasInventory">${currentData.story.hasInventory}</span></p>`),currentData.story.hasInventory&&(e=(e+=`${editableProperty}<strong>Inventory Name:</strong>${editableSpan}data-property="inventoryName">${currentData.story.inventoryName}</span></p>`)+`${editableProperty}<strong>Inventory Empty:</strong>${editableSpan}data-property="inventoryEmpty">${currentData.story.inventoryEmpty}</span></p>`),n.innerHTML+=e}else if(o.startsWith("chapter-")){var i=parseInt(o.split("-")[1]),i=(currentData.story.chapters[i],`
      ${panelHeader}class="bg-chapter">${headerLabel.emoji.chapter} ${headerLabel.text.chapter}</div>
    `);n.innerHTML+=i}else if(o.startsWith("paragraph-")){var[,i,s]=o.split("-").map(Number);let e,t,a,r=("interactive"===(i=currentData.story.chapters[i].paragraphs[s]).type?(t=""+headerLabel.text.interactive,e=headerLabel.emoji.interactive+" "+headerLabel.text.interactive,a="bg-interactive"):"passThru"===i.type?(t=""+headerLabel.text.passThru,e=headerLabel.emoji.passThru+" "+headerLabel.text.passThru,a="bg-passthru"):"infoBox"===i.type&&(t=""+headerLabel.text.infoBox,e=headerLabel.emoji.infoBox+" "+headerLabel.text.infoBox,a="bg-infobox"),`
      ${panelHeader}class="${a}">${e}</div>
      ${property}<strong>ID:</strong>${editableSpan}data-property="id">${i.id}</span></p>
      ${""}
      ${editableProperty}<strong>Text:</strong><br>${editableSpan}data-property="text_body"></span></p>
      ${editableProperty}<strong>Image:</strong>${editableSpan}data-property="image">${i.image}</span></p>
    `);"passThru"!==i.type&&"infoBox"!==i.type||(r+=`${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${i.destination_id||""}</span></p>`),n.innerHTML+=r;(s=document.querySelector('[data-property="text_body"]'))&&(s.textContent=i.text_body);var s=document.querySelector('[data-property="id"]'),l=document.querySelector('[data-property="destination_id"]');validateUInt(s,i.id),"infoBox"!==i.type&&validateUInt(l,i.destination_id)}else o.startsWith("choice-")&&([,s,l,i]=o.split("-").map(Number),s=currentData.story.chapters[s].paragraphs[l].choices[i],n.innerHTML+=`
      ${panelHeader}class="bg-choice">${headerLabel.emoji.choice} ${headerLabel.text.choice}</div>
      ${editableProperty}<strong>Text:</strong>${editableSpan}data-property="text_body">${s.text_body}</span></p>
      ${editableProperty}<strong>Destination ID:</strong>${editableSpan}data-property="destination_id">${s.destination_id}</span></p>
    `,validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),s.destination_id));if(document.getElementById("closePropertiesPanel").addEventListener("click",()=>{removeHighlightFromBlocks(),togglePropertiesPanelVisibility(!1)}),document.querySelectorAll(".editable-property").forEach(e=>{var t=(e=e.querySelector(".editable")).getAttribute("data-property"),a=createEditButton(e,o,t);e.parentNode.appendChild(a),o.startsWith("paragraph-")&&"image"===t&&(a=createImagePreviewIcon(e,o,t),e.parentNode.appendChild(a))}),setupImagePreview(),(l=document.createElement("div")).classList.add("panel-buttons-container"),"story"!==o){let e=document.querySelector(`[data-id="${o}"]`);e&&"interactive"===e.dataset.type&&((i=document.createElement("button")).innerText="🎯 Add Choice",i.classList.add("new-choice-button"),i.addEventListener("click",()=>createNewChoice(e)),l.appendChild(i)),(s=document.createElement("button")).innerText="🗑️ Delete...",s.classList.add("delete-button"),s.addEventListener("click",()=>deleteBlock(o)),l.appendChild(s)}n.appendChild(l)}function updateDataFromPanel(e,t,a){var r,o,n,i;"story"===e?("typingSpeed"===t?a=Number(a):"hasInventory"===t&&(a="true"===a.toLowerCase()),currentData.story[t]=a):e.startsWith("chapter-")?(r=parseInt(e.split("-")[1]),"id"===t?(a=Number(a),currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".id-label"))&&(i.innerText="ID: "+a)):"title"===t?(currentData.story.chapters[r][t]=a,(i=(i=document.querySelector(`.block[data-id="${e}"]`))&&i.querySelector(".type-label"))&&(i.innerText=a)):currentData.story.chapters[r][t]=a):e.startsWith("paragraph-")?([,i,r]=e.split("-").map(Number),"id"===t?(a=Number(a),currentData.story.chapters[i].paragraphs[r][t]=a,(n=document.querySelector(`.block[data-id="${e}"]`))&&(n.dataset.jsonId=a,(n=n.querySelector(".id-label"))&&(n.innerText="ID: "+a),updateConnections())):"destination_id"===t?(a&&""!==a.trim()?currentData.story.chapters[i].paragraphs[r][t]=a:delete currentData.story.chapters[i].paragraphs[r][t],validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=n.querySelector(".destination-label"),n.dataset.destId=a||"",o&&(o.innerText="Destination ID: "+(a||"")),updateConnections())):"image"===t?"undefined"===a||""===a.trim()?delete currentData.story.chapters[i].paragraphs[r][t]:currentData.story.chapters[i].paragraphs[r][t]=a:"text_body"===t?(currentData.story.chapters[i].paragraphs[r][t]=a,(n=(n=document.querySelector(`.block[data-id="${e}"]`))&&(o=Array.from(n.getElementsByClassName("textbody-label")))[o.length-1])&&(n.innerText=a)):currentData.story.chapters[i].paragraphs[r][t]=a):e.startsWith("choice-")&&([,o,n,i]=e.split("-").map(Number),currentData.story.chapters[o].paragraphs[n].choices[i][t]=a,"destination_id"===t?(r=document.querySelector(`.block[data-id="${e}"]`))&&(r.dataset.destId=a,(o=r.querySelector(".destination-label"))&&(o.innerText="Destination ID: "+a),validateUInt(destIdElement=document.querySelector('[data-property="destination_id"]'),a),updateConnections()):"text_body"===t&&(n=document.querySelector(`.block[data-id="${e}"]`))&&(i=n.querySelector(".keyword-label"))&&(i.innerText=a))}function showConfirmationDialog(e){let t=document.getElementById("dialogOverlay"),a=document.getElementById("confirmationDialog"),r=document.getElementById("dialogCancel"),o=document.getElementById("dialogOK"),n=(t.style.display="block",a.style.display="block",()=>{t.style.display="none",a.style.display="none",s()}),i=()=>{t.style.display="none",a.style.display="none",s(),e()},s=()=>{r.removeEventListener("click",n),o.removeEventListener("click",i)};r.addEventListener("click",n),o.addEventListener("click",i)}function deleteBlock(a){showConfirmationDialog(()=>{var e=document.querySelector(`[data-id="${a}"]`);if(e){if(a.startsWith("paragraph-")){let[,n,i]=a.split("-").map(Number),e=currentData.story.chapters[n].paragraphs[i].id,t=currentData.story.chapters[n].paragraphs.splice(i,1)[0];delete paragraphBlocksByJsonId[e],t.choices&&t.choices.forEach((e,t)=>{var t=`choice-${n}-${i}-`+t,a=blocks[t];a&&(a.remove(),delete blocks[t])}),currentData.story.chapters[n].paragraphs.forEach((e,o)=>{var t,a,r;o>=i&&(t=`paragraph-${n}-`+(o+1),a=`paragraph-${n}-`+o,r=blocks[t])&&(r.setAttribute("data-id",a),blocks[a]=r,delete blocks[t],e.choices)&&e.choices.forEach((e,t)=>{var a=`choice-${n}-${o+1}-`+t,t=`choice-${n}-${o}-`+t,r=blocks[a];r&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})})}else if(a.startsWith("choice-")){let[,o,n,i]=a.split("-").map(Number);currentData.story.chapters[o].paragraphs[n].choices.splice(i,1),currentData.story.chapters[o].paragraphs[n].choices.forEach((e,t)=>{var a,r;t>=i&&(a=`choice-${o}-${n}-`+(t+1),t=`choice-${o}-${n}-`+t,r=blocks[a])&&(r.setAttribute("data-id",t),blocks[t]=r,delete blocks[a])})}delete blocks[a],e.remove(),connections=connections.filter(e=>e.from!==a&&e.to!==a),choiceConnections=choiceConnections.filter(e=>e.from!==a&&e.to!==a),updateConnections(),togglePropertiesPanelVisibility(!1)}})}function setupImagePreview(){let e=document.querySelector('[data-property="image"]');if(e){var t=e.parentElement.querySelector(".image-preview-icon");if(t){let n=document.querySelector(".image-preview-tooltip");n||((n=document.createElement("div")).className="image-preview-tooltip",document.body.appendChild(n)),t.addEventListener("mouseover",o=>{if(!isEditingImage){let r=e.textContent;if(r){let a=new Image;a.onload=()=>{n.className="image-preview-tooltip",n.style.backgroundImage=`url(${r})`,n.textContent="";var e=a.height/a.width,t=Math.min(200,a.width),e=t*e,e=(n.style.width=t+"px",n.style.height=e+"px",window.innerWidth),e=o.clientX+(t=t+10)>e;n.style.left=e?o.clientX-t+"px":o.clientX+10+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.onerror=()=>{n.className="image-preview-tooltip error",n.style.backgroundImage="none",n.textContent="⛔ Image not found",n.style.width="120px",n.style.height="20px",n.style.left=o.clientX-120+"px",n.style.top=o.clientY+20+"px",n.style.display="block"},a.src=r}else n.style.display="none"}}),t.addEventListener("mouseleave",()=>{n.style.display="none"})}}}function validateUInt(e,t){e&&(/^\d+$/.test(t)?e.parentNode.style.color="black":e.parentNode.style.color="red",e.textContent=t)}function togglePropertiesPanelVisibility(e){document.getElementById("propertiesPanel").style.display=e?"block":"none"}</script></body></html>